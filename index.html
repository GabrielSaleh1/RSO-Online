<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RSO ‚Ä¢ ROTA</title>
<style>
  :root{
    --bg:#0b0d10;
    --panel:#0f1318;
    --muted:#a7adb7;
    --text:#e6e9ee;
    --line:#262e3a;
    --brand:#c9a227;
    --btn:#c9a227;
    --btnH:#a8881f;
    --btnDanger:#c62828;
    --btnDangerH:#a02020;
    --field:#0c1015;
    --chip:#131a22;
    --chipH:#18212c;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:28px auto;padding:0 16px}

  /* Header */
  .brand{display:flex;align-items:center;gap:14px;justify-content:center;margin-bottom:18px}
  .brand .mark{
    width:80px;height:80px;border-radius:14px;
    display:grid;place-items:center;
    background:linear-gradient(145deg,#1b222d,#0e141b);
    border:2px solid var(--brand);
    box-shadow:0 0 18px rgba(201,162,39,.25);
    font-size:40px;color:var(--brand);font-weight:900;
  }
  .brand .mark::before{content:"‚ö°"}
  h1{margin:0;text-align:center;font-weight:900;letter-spacing:.2px;font-size:1.7rem}
  h1 .accent{color:var(--brand)}
  .subtitle{margin:6px 0 0;text-align:center;color:var(--muted);font-size:.95rem}

  /* Pain√©is / Form */
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;margin-bottom:14px;box-shadow:0 10px 26px rgba(0,0,0,.32)}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .row>div{flex:1 1 260px;min-width:220px}
  label{display:block;font-weight:700;font-size:.92rem;margin:6px 0}
  input,textarea,select{width:100%;background:var(--field);border:1px solid var(--line);color:var(--text);padding:11px 12px;border-radius:12px}
  textarea{min-height:72px;resize:vertical}
  .list{display:grid;gap:10px}
  .item,.item-2{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .item-2 input[type="time"]{width:110px}
  .pill{border:1px dashed var(--line);border-radius:12px;padding:10px 12px;text-align:center;cursor:pointer;color:#efe6c4;background:var(--chip);font-weight:800}
  .pill:hover{background:var(--chipH)}
  .muted{color:var(--muted);font-size:.85rem}
  .btn{display:block;width:100%;text-align:center;background:var(--btn);color:#1a1a1a;border:none;border-radius:12px;padding:14px;font-weight:900;cursor:pointer;margin:6px 0}
  .btn:hover{background:var(--btnH)}
  .btn-danger{background:var(--btnDanger);color:#fff}
  .btn-danger:hover{background:var(--btnDangerH)}
  .btn-sec{background:var(--chip);border:1px solid var(--line);color:#f6e9b8}
  @media (max-width:720px){ .row>div{flex:1 1 100%;min-width:unset} }

  /* Impress√£o A4 */
  @page{size:A4;margin:14mm}
  @media print{
    body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}
    #form-area{display:none!important}
    #sheet{display:block!important}
  }
  #sheet{display:none;background:#fff;color:#0b0b0b;border:1px solid #bfc8d6;border-radius:8px;padding:14mm;width:100%;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .doc-header{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:8px}
  .doc-mark{
    width:48px;height:48px;border-radius:8px;display:grid;place-items:center;
    background:linear-gradient(145deg,#1b222d,#0e141b);
    border:1px solid #c9d4e8;color:#d4b64c;font-weight:900;font-size:22px
  }
  .doc-mark::before{content:"‚ö°"}
  .doc-title{font-weight:900;font-size:20px;color:#0d2a5c;margin:0 0 2px;text-align:center}
  .doc-sub{font-size:12px;color:#3b4a63;margin:0;text-align:center}
  .doc-rule{height:1px;background:linear-gradient(90deg,#ccd6e4 0,#d4b64c 40%,#ccd6e4 100%);margin:10px 0 14px;border:none}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:4px 12px;font-size:13px}
  ul.clean{margin:0;padding-left:16px;font-size:13px}
  .footer-rule{height:1px;background:#ccd6e4;margin:12px 0 8px}
  .doc-footer{display:flex;justify-content:space-between;font-size:11px;color:#506079}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <div class="mark" aria-hidden="true"></div>
    <div>
      <h1><span class="accent">ROTA</span> ‚Ä¢ Relat√≥rio de Servi√ßo Operacional</h1>
      <p class="subtitle">Batalh√£o de Pol√≠cia de Choque ‚Äî Rondas Ostensivas Tobias de Aguiar</p>
    </div>
  </div>

  <div id="form-area">
    <div class="panel">
      <div class="row">
        <div><label>Data/Hora</label><input id="datahora" type="datetime-local"></div>
        <div><label>Rota</label><input id="rota" placeholder="91136"></div>
      </div>
      <div class="muted" style="margin-top:8px">Identificador num√©rico descontinuado <span class="flag">N¬∫ RSO removido</span></div>
    </div>

    <div class="panel">
      <div class="row">
        <div><label>Motorista (Nome)</label><select id="motorista_sel"></select></div>
        <div><label>Motorista (Patente)</label><select id="motorista_rank"></select></div>
      </div>
      <div class="row">
        <div><label>Encarregado (Nome)</label><select id="encarregado_sel"></select></div>
        <div><label>Encarregado (Patente)</label><select id="encarregado_rank"></select></div>
      </div>
      <div class="row">
        <div><label>Seguran√ßa (Nome)</label><select id="seguranca_sel"></select></div>
        <div><label>Seguran√ßa (Patente)</label><select id="seguranca_rank"></select></div>
      </div>
      <div class="row">
        <div><label>Auxiliar (Nome)</label><select id="auxiliares_sel"></select></div>
        <div><label>Auxiliar (Patente)</label><select id="auxiliares_rank"></select></div>
      </div>
    </div>

    <!-- Abordados acima de Il√≠citos -->
    <div class="panel">
      <label>Abordados</label>
      <div id="list-abordados" class="list"></div>
      <div class="pill" onclick="addAbordado()">+ adicionar abordado</div>
    </div>

    <div class="panel">
      <label>Il√≠citos</label>
      <div id="list-ilicitos" class="list"></div>
      <div class="pill" onclick="addIlicito()">+ adicionar il√≠cito</div>
    </div>

    <div class="panel">
      <label>Ve√≠culos</label>
      <div id="list-veiculos" class="list"></div>
      <div class="pill" onclick="addVeiculo()">+ adicionar ve√≠culo</div>
    </div>

    <div class="panel">
      <label>Ocorr√™ncias</label>
      <div id="list-ocorrencias" class="list"></div>
      <div class="pill" onclick="addOcorrencia()">+ adicionar ocorr√™ncia</div>
    </div>

    <div class="panel">
      <div class="row">
        <div><label>Ocorr√™ncias (qtd)</label><input id="res-oc" type="number" min="0" value="0"></div>
        <div><label>Apoios (qtd)</label><input id="res-ap" type="number" min="0" value="0"></div>
      </div>
      <div class="row">
        <div><label>A√ß√µes (qtd)</label><input id="res-ac" type="number" min="0" value="0"></div>
      </div>
    </div>

    <!-- Bot√µes empilhados -->
    <div class="panel" style="display:flex;flex-direction:column;gap:8px;align-items:stretch">
      <button class="btn" id="saveCloudBtn" type="button">üíæ Salvar il√≠citos</button>
      <button class="btn btn-danger" id="printBtn" type="button">üßæ Imprimir / PDF</button>
      <button class="btn btn-sec" id="totalsBtn" type="button">Totais 7 dias</button>
    </div>

    <div id="totalsPanel" class="panel" style="display:none">
      <h3 style="margin:0 0 10px">Totais por policial (√∫ltimos 7 dias)</h3>
      <div id="totalsContent"></div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn btn-sec" id="exportCsvBtn" type="button">Exportar CSV</button>
        <button class="btn btn-sec" type="button" onclick="document.getElementById('totalsPanel').style.display='none'">Fechar</button>
      </div>
    </div>
  </div>

  <!-- FOLHA A4 (tamb√©m com Abordados acima de Il√≠citos) -->
  <div id="sheet">
    <div class="doc-header">
      <div class="doc-mark" aria-hidden="true"></div>
      <div>
        <h2 class="doc-title">ROTA ‚Ä¢ Relat√≥rio de Servi√ßo Operacional</h2>
        <p class="doc-sub">Batalh√£o de Pol√≠cia de Choque ‚Äî Documento gerado automaticamente</p>
      </div>
    </div>
    <hr class="doc-rule">
    <div class="meta"><span id="meta-data">Data/Hora: ‚Äî</span><span id="meta-rota">Rota: ‚Äî</span></div>
    <div class="section"><h3>EFETIVO</h3>
      <div class="kv">
        <b>Motorista:</b><span id="k-motorista">‚Äî</span>
        <b>Encarregado:</b><span id="k-encarregado">‚Äî</span>
        <b>Seguran√ßa:</b><span id="k-seguranca">‚Äî</span>
        <b>Auxiliar:</b><span id="k-auxiliares">‚Äî</span>
      </div>
    </div>
    <div class="section"><h3>ABORDADOS</h3><ul class="clean" id="ul-abordados"><li>‚Äî</li></ul></div>
    <div class="section"><h3>IL√çCITOS</h3><ul class="clean" id="ul-ilicitos"><li>‚Äî</li></ul></div>
    <div class="section"><h3>VE√çCULOS</h3><ul class="clean" id="ul-veiculos"><li>‚Äî</li></ul></div>
    <div class="section"><h3>OCORR√äNCIAS</h3><ul class="clean" id="ul-ocorrencias"><li>‚Äî</li></ul></div>
    <div class="section"><h3>RESULTADO</h3><ul class="clean" id="ul-resultado"><li>0x Ocorr√™ncia.</li><li>0x Apoio.</li><li>0x A√ß√£o.</li></ul></div>
    <hr class="footer-rule"><div class="doc-footer"><div>RSO ‚Ä¢ ROTA</div><div id="rodape-data">‚Äî</div></div>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);
  const pad2 = n => String(n).padStart(2,'0');
  const esc = s => (s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

  // === Supabase ===
  const SUPABASE_URL = 'https://ilonwkgtdszmpcjwlezc.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsb253a2d0ZHN6bXBjandsZXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzQxMDIsImV4cCI6MjA3NTU1MDEwMn0.Cc-BtnHlXaGVCY6T6iXe0QA1tsfc17aX8lswEICvtw0';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // === Estado de ‚Äúsalvo‚Äù para alerta inteligente ===
  let lastSavedIllicitHash = '';
  const getIllicitText = () =>
    [...document.querySelectorAll('#list-ilicitos input')].map(i=>i.value.trim()).filter(Boolean).join('\n');
  const hash = str => { let h=5381; for(let i=0;i<str.length;i++){ h=((h<<5)+h)+str.charCodeAt(i); h|=0; } return String(h); };

  // === Ranks & Officers ===
  let RANKS = [], OFFICERS = [];
  const NAME_SELECTS = ['motorista_sel','encarregado_sel','seguranca_sel','auxiliares_sel'];
  const RANK_SELECTS = ['motorista_rank','encarregado_rank','seguranca_rank','auxiliares_rank'];

  async function loadRanks(){
    const { data, error } = await supa.from('ranks').select('id,name,sort_order').order('sort_order',{ascending:true});
    if(error){ console.error(error); alert('Erro ao carregar patentes.'); return; }
    RANKS = data || [];
    RANK_SELECTS.forEach(id=>{
      $(id).innerHTML = `<option value="">Selecione a patente‚Ä¶</option>` + RANKS.map(r=>`<option value="${r.id}">${esc(r.name)}</option>`).join('');
    });
  }

  async function loadOfficers(){
    const { data, error } = await supa.from('officers').select('id,name,current_rank_id').eq('active',true).order('name');
    if(error){ console.error(error); alert('Erro ao carregar policiais.'); return; }
    OFFICERS = data || [];
    NAME_SELECTS.forEach(id=>{
      $(id).innerHTML = `<option value="">Selecione‚Ä¶</option>` + OFFICERS.map(o=>`<option value="${esc(o.id)}">${esc(o.name)}</option>`).join('');
    });
  }

  function linkNameToRank(){
    NAME_SELECTS.forEach((nameId, idx) => {
      const rankId = RANK_SELECTS[idx];
      $(nameId).addEventListener('change', (e) => {
        const val = e.target.value;
        const off = OFFICERS.find(o => o.id === val);
        $(rankId).value = off?.current_rank_id || '';
      });
    });
  }

  // ===== Campos din√¢micos =====
  function mkItem(id,v,ph){
    const w=document.createElement('div'); w.className='item';
    w.innerHTML=`<input placeholder="${ph}" value="${v}"><button class="btn btn-sec" type="button">remover</button>`;
    w.querySelector('button').onclick=()=>w.remove();
    $(id).appendChild(w);
  }
  function addIlicito(v=''){ mkItem('list-ilicitos',v,'ex.: 02x Maconha'); }
  function addVeiculo(v=''){ mkItem('list-veiculos',v,'ex.: BMW R1250 HP - Branca - 57URU265 - Apreendida'); }
  function addAbordado(v=''){ mkItem('list-abordados',v,'ex.: Renato Cruz ‚Äì 4910 ‚Äì BOPM ‚Äì Cb Ducati 20:14'); }
  function addOcorrencia(h='',t=''){
    const w=document.createElement('div'); w.className='item-2';
    w.innerHTML=`<input type="time" value="${h}"><input placeholder="Descreva a ocorr√™ncia" value="${t}"><button class="btn btn-sec" type="button">remover</button>`;
    w.querySelector('button').onclick=()=>w.remove();
    $('list-ocorrencias').appendChild(w);
  }

  // ===== Coleta e impress√£o =====
  function collect(){
    const L=id=>[...$(id).querySelectorAll('input')].map(i=>i.value).filter(Boolean);
    const O=[...$('list-ocorrencias').children].map(d=>{const [h,t]=d.querySelectorAll('input');return{h:h.value,t:t.value}}).filter(o=>o.t);

    const officerById = id => OFFICERS.find(o => o.id === id)?.name || '';
    const rankById = id => RANKS.find(r => String(r.id) === String(id))?.name || '';
    const mName = officerById($('motorista_sel').value);
    const eName = officerById($('encarregado_sel').value);
    const sName = officerById($('seguranca_sel').value);
    const aName = officerById($('auxiliares_sel').value);
    const mRank = rankById($('motorista_rank').value);
    const eRank = rankById($('encarregado_rank').value);
    const sRank = rankById($('seguranca_rank').value);
    const aRank = rankById($('auxiliares_rank').value);

    return{
      datahora:$('datahora').value, rota:$('rota').value,
      motorista: mRank && mName ? `${mRank} ${mName}` : (mName || ''),
      encarregado: eRank && eName ? `${eRank} ${eName}` : (eName || ''),
      seguranca: sRank && sName ? `${sRank} ${sName}` : (sName || ''),
      auxiliares: aRank && aName ? `${aRank} ${aName}` : (aName || ''),
      ilicitos:L('list-ilicitos'), veiculos:L('list-veiculos'),
      ocorrencias:O, abordados:L('list-abordados'),
      resOc:+($('res-oc').value||0), resAp:+($('res-ap').value||0), resAc:+($('res-ac').value||0)
    };
  }

  function fillSheet(d){
    const dt=d.datahora?new Date(d.datahora):new Date();
    const dd=`${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
    $('meta-data').textContent=`Data/Hora: ${dd}`;
    $('meta-rota').textContent=`Rota: ${d.rota||'‚Äî'}`;
    $('k-motorista').textContent=d.motorista||'‚Äî';
    $('k-encarregado').textContent=d.encarregado||'‚Äî';
    $('k-seguranca').textContent=d.seguranca||'‚Äî';
    $('k-auxiliares').textContent=d.auxiliares||'‚Äî';

    const setList=(id,a)=>{
      const u=$(id); u.innerHTML='';
      if(!a||!a.length){u.innerHTML='<li>‚Äî</li>';return}
      a.forEach(v=>{const li=document.createElement('li'); li.innerHTML=esc(v); u.appendChild(li);});
    };
    setList('ul-abordados',d.abordados);
    setList('ul-ilicitos',d.ilicitos);
    setList('ul-veiculos',d.veiculos);

    const ulO=$('ul-ocorrencias'); ulO.innerHTML='';
    if(!d.ocorrencias.length){ulO.innerHTML='<li>‚Äî</li>';}
    else{
      d.ocorrencias.sort((a,b)=>(a.h||'').localeCompare(b.h||'')).forEach(o=>{
        const li=document.createElement('li'); li.innerHTML=esc(o.h?`√ÄS ${o.h}: ${o.t}`:o.t); ulO.appendChild(li);
      });
    }
    $('ul-resultado').innerHTML=`<li>${d.resOc}x Ocorr√™ncia.</li><li>${d.resAp}x Apoio.</li><li>${d.resAc}x A√ß√£o.</li>`;
    const now=new Date(); $('rodape-data').textContent=`Emitido em ${pad2(now.getDate())}/${pad2(now.getMonth()+1)}/${now.getFullYear()} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  }

  // ===== Parser de il√≠citos =====
  function parseIlicitosText(multiline){
    const parts = (multiline||'').split(/\n|,|;/).map(s=>s.trim()).filter(Boolean);
    const out=[];
    for(const p of parts){
      let m = p.match(/^(\d+)\s*[x√ó]?\s*(.+)$/i) || p.match(/^(\d+)\s+(.+)$/i);
      if(m){ out.push({item:m[2].trim().toLowerCase(), qty:parseInt(m[1],10)}); continue; }
      const m2 = p.match(/(\d+)/);
      if(m2){ out.push({item:p.replace(m2[0],'').trim().toLowerCase()||'desconhecido', qty:parseInt(m2[1],10)}); }
      else{ out.push({item:p.toLowerCase(), qty:1}); }
    }
    return out;
  }

  function selectedOfficerAndRankPairs(){
    const pairs = [];
    const make = (selId, rankId) => {
      const officerId = $(selId).value || '';
      const rankSel = $(rankId).value || '';
      if(!officerId || !rankSel) return;
      const officer = OFFICERS.find(o => o.id === officerId);
      const rankObj = RANKS.find(r => String(r.id) === String(rankSel));
      pairs.push({ name: officer?.name || '', rank_name: rankObj?.name || '' });
    };
    make('motorista_sel','motorista_rank');
    make('encarregado_sel','encarregado_rank');
    make('seguranca_sel','seguranca_rank');
    make('auxiliares_sel','auxiliares_rank');
    return pairs.filter(p => p.name && p.rank_name);
  }

  // ===== Salvar il√≠citos (Supabase) =====
  async function saveIllicitsToSupabase(){
    const rota = ($('rota').value || '').trim() || null;
    const lines = [...document.querySelectorAll('#list-ilicitos input')].map(i=>i.value).filter(Boolean).join('\n');
    const items = parseIlicitosText(lines);
    const pairs = selectedOfficerAndRankPairs();

    if(!items.length){ alert('Preencha ao menos 1 il√≠cito.'); return; }
    if(!pairs.length){ alert('Selecione Nome e Patente para a equipe.'); return; }

    const rows = pairs.flatMap(({name, rank_name}) =>
      items.map(({item, qty}) => ({
        officer: name,
        rank_at_time: rank_name,
        rota,
        item_type: item,
        quantity: Number(qty)
      }))
    );

    const btn = $('saveCloudBtn'); const old = btn.textContent;
    btn.textContent = 'Salvando‚Ä¶'; btn.disabled = true;
    try{
      const { error } = await supa.from('rso_items').insert(rows);
      if(error){ console.error(error); alert('Falha ao salvar no Supabase. Veja o console.'); return; }
      btn.textContent = 'Salvo!';
      lastSavedIllicitHash = hash(lines); // marca como salvo
    }catch(e){
      console.error(e); alert('Falha de rede/JS. Veja o console.');
    }finally{
      setTimeout(()=>{ btn.textContent = old; btn.disabled=false; }, 1200);
    }
  }

  // ===== Totais 7 dias =====
  async function showTotals7d(){
    const cutoff = new Date(Date.now()-7*24*60*60*1000).toISOString();
    const { data, error } = await supa
      .from('rso_items')
      .select('officer,item_type,quantity,recorded_at')
      .gte('recorded_at', cutoff);

    if(error){ console.error(error); alert('Erro ao buscar totais. Veja o console.'); return; }

    const agg = {};
    (data||[]).forEach(r=>{
      const off = r.officer || '‚Äî';
      if(!agg[off]) agg[off] = {};
      agg[off][r.item_type] = (agg[off][r.item_type] || 0) + Number(r.quantity || 0);
    });
    renderTotals(agg);
  }

  function renderTotals(agg){
    const c = $('totalsContent');
    if(!agg || !Object.keys(agg).length){
      c.innerHTML='<div class="muted">Sem dados nos √∫ltimos 7 dias.</div>';
      $('totalsPanel').style.display='block';
      return;
    }
    let html = '';
    Object.keys(agg).sort().forEach(off=>{
      html += `<h4 style="margin:10px 0 6px">${esc(off)}</h4>`;
      html += `<table class="tot" style="width:100%;border-collapse:separate;border-spacing:0 6px"><thead><tr><th style="text-align:left;border:1px solid #d2dae6;padding:10px 12px;background:#f3f6fb">Item</th><th style="text-align:left;border:1px solid #d2dae6;padding:10px 12px;background:#f3f6fb">Quantidade</th></tr></thead><tbody>`;
      const items = agg[off];
      Object.keys(items).sort().forEach(it=>{
        html += `<tr><td style="border:1px solid #d2dae6;padding:10px 12px">${esc(it)}</td><td style="border:1px solid #d2dae6;padding:10px 12px">${items[it]}</td></tr>`;
      });
      html += `</tbody></table>`;
    });
    c.innerHTML = html;
    $('totalsPanel').style.display = 'block';
    $('exportCsvBtn').onclick = ()=> exportTotalsCSV(agg);
  }

  function exportTotalsCSV(agg){
    const rows = [['policial','item','total']];
    Object.entries(agg).forEach(([off, items])=>{
      Object.entries(items).forEach(([item, total])=>{
        rows.push([off, item, total]);
      });
    });
    const escapeCSV = s => /[",;\n]/.test(String(s)) ? `"${String(s).replace(/"/g,'""')}"` : s;
    const csv = rows.map(r=>r.map(escapeCSV).join(';')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='RSO-totais-7dias.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // ===== Inicializa√ß√£o =====
  (async function init(){
    await loadRanks();
    await loadOfficers();
    linkNameToRank();

    // data/hora default
    const d=new Date(), z=n=>String(n).padStart(2,'0');
    $('datahora').value = `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`;

    // listas default
    if(!$('list-abordados').children.length) addAbordado();
    if(!$('list-ilicitos').children.length) addIlicito();
    if(!$('list-veiculos').children.length) addVeiculo();
    if(!$('list-ocorrencias').children.length) addOcorrencia();

    // eventos
    $('saveCloudBtn').addEventListener('click', saveIllicitsToSupabase);
    $('totalsBtn').addEventListener('click', showTotals7d);

    // Alerta inteligente no imprimir
    $('printBtn').addEventListener('click', ()=>{
      const currentHash = hash(getIllicitText());
      if(currentHash !== lastSavedIllicitHash){
        const goOn = confirm('‚ö†Ô∏è Il√≠citos parecem N√ÉO estar salvos.\nClique em ‚ÄúOK‚Äù para imprimir mesmo assim, ou ‚ÄúCancelar‚Äù para voltar e salvar.');
        if(!goOn) return;
      }
      const d=collect(); fillSheet(d); window.print();
    });

    // Preencher antes de imprimir
    window.onbeforeprint = ()=> fillSheet(collect());
  })();
</script>
</body>
</html>
