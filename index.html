<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RSO • ROTA</title>
<style>
  :root{
    --bg:#0b0d10;
    --panel:#0f1318;
    --muted:#a7adb7;
    --text:#e6e9ee;
    --line:#262e3a;
    --brand:#c9a227;
    --brand-2:#c62828;
    --btn:#c9a227;
    --btnH:#a8881f;
    --field:#0c1015;
    --chip:#131a22;
    --chipH:#18212c;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:28px auto;padding:0 16px}
  .brand{display:flex;align-items:center;gap:14px;justify-content:center;margin-bottom:18px}
  .brand .mark img{width:80px;height:80px;border-radius:14px;border:2px solid var(--brand);background:#111;box-shadow:0 0 18px rgba(201,162,39,.25)}
  h1{margin:0;text-align:center;font-weight:900;letter-spacing:.2px;font-size:1.7rem}
  h1 .accent{color:var(--brand)}
  .subtitle{margin:6px 0 0;text-align:center;color:var(--muted);font-size:.95rem}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;margin-bottom:14px;box-shadow:0 10px 26px rgba(0,0,0,.32)}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .row>div{flex:1 1 260px;min-width:220px}
  label{display:block;font-weight:700;font-size:.92rem;margin:6px 0}
  input,textarea,select{width:100%;background:var(--field);border:1px solid var(--line);color:var(--text);padding:11px 12px;border-radius:12px}
  textarea{min-height:72px;resize:vertical}
  .pill{border:1px dashed var(--line);border-radius:12px;padding:10px 12px;text-align:center;cursor:pointer;color:#efe6c4;background:var(--chip);font-weight:800}
  .pill:hover{background:var(--chipH)}
  .muted{color:var(--muted);font-size:.85rem}
  .btn{background:var(--btn);color:#1a1a1a;border:none;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer}
  .btn:hover{background:var(--btnH)}
  .btn-sec{background:var(--chip);border:1px solid var(--line);color:#f6e9b8}
  .flag{display:inline-block;font-size:.78rem;font-weight:900;background:rgba(198,40,40,.12);border:1px solid rgba(198,40,40,.35);color:#ffb4b4;border-radius:999px;padding:6px 10px}
  @media (max-width:720px){ .row>div{flex:1 1 100%;min-width:unset} }
  @page{size:A4;margin:14mm}
  @media print{
    body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}
    #form-area{display:none!important}
    #sheet{display:block!important}
  }
  #sheet{display:none;background:#fff;color:#0b0b0b;border:1px solid #bfc8d6;border-radius:8px;padding:14mm;width:100%;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .doc-header{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:8px}
  .doc-mark img{width:48px;height:48px;border-radius:8px;border:1px solid #c9d4e8}
  .doc-title{font-weight:900;font-size:20px;color:#0d2a5c;margin:0 0 2px;text-align:center}
  .doc-sub{font-size:12px;color:#3b4a63;margin:0;text-align:center}
  .doc-rule{height:1px;background:linear-gradient(90deg,#ccd6e4 0,#d4b64c 40%,#ccd6e4 100%);margin:10px 0 14px;border:none}
</style>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="mark">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/00/Bras%C3%A3o_da_ROTA.svg" alt="Brasão da ROTA">
      </div>
      <div>
        <h1><span class="accent">ROTA</span> • Relatório de Serviço Operacional</h1>
        <p class="subtitle">Batalhão de Polícia de Choque — Rondas Ostensivas Tobias de Aguiar</p>
      </div>
    </div>

    <div id="form-area">
      <div class="panel">
        <div class="row">
          <div><label>Data/Hora</label><input id="datahora" type="datetime-local"></div>
          <div><label>Rota</label><input id="rota" placeholder="91136"></div>
        </div>
        <div class="muted" style="margin-top:8px">Identificador numérico descontinuado <span class="flag">Nº RSO removido</span></div>
      </div>

      <div class="panel">
        <div class="row">
          <div><label>Motorista</label><select id="motorista_sel"></select></div>
          <div><label>Patente</label><select id="motorista_rank"></select></div>
        </div>
        <div class="row">
          <div><label>Encarregado</label><select id="encarregado_sel"></select></div>
          <div><label>Patente</label><select id="encarregado_rank"></select></div>
        </div>
        <div class="row">
          <div><label>Segurança</label><select id="seguranca_sel"></select></div>
          <div><label>Patente</label><select id="seguranca_rank"></select></div>
        </div>
        <div class="row">
          <div><label>Auxiliar</label><select id="auxiliares_sel"></select></div>
          <div><label>Patente</label><select id="auxiliares_rank"></select></div>
        </div>
      </div>

      <div class="panel"><label>Ilícitos</label><div id="list-ilicitos" class="list"></div><div class="pill" onclick="addIlicito()">+ adicionar ilícito</div></div>
      <div class="panel"><label>Veículos</label><div id="list-veiculos" class="list"></div><div class="pill" onclick="addVeiculo()">+ adicionar veículo</div></div>
      <div class="panel"><label>Ocorrências</label><div id="list-ocorrencias" class="list"></div><div class="pill" onclick="addOcorrencia()">+ adicionar ocorrência</div></div>
      <div class="panel"><label>Abordados</label><div id="list-abordados" class="list"></div><div class="pill" onclick="addAbordado()">+ adicionar abordado</div></div>

      <div class="panel">
        <div class="row">
          <div><label>Ocorrências (qtd)</label><input id="res-oc" type="number" min="0" value="0"></div>
          <div><label>Apoios (qtd)</label><input id="res-ap" type="number" min="0" value="0"></div>
        </div>
        <div class="row">
          <div><label>Ações (qtd)</label><input id="res-ac" type="number" min="0" value="0"></div>
        </div>
      </div>

      <div class="panel" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn" id="saveCloudBtn" type="button">Salvar ilícitos</button>
        <button class="btn btn-sec" id="totalsBtn" type="button">Totais 7 dias</button>
        <button class="btn" id="printBtn" type="button">Imprimir / PDF</button>
      </div>

      <div id="totalsPanel" class="panel" style="display:none">
        <h3 style="margin:0 0 10px">Totais por policial (últimos 7 dias)</h3>
        <div id="totalsContent"></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn btn-sec" id="exportCsvBtn" type="button">Exportar CSV</button>
          <button class="btn btn-sec" type="button" onclick="document.getElementById('totalsPanel').style.display='none'">Fechar</button>
        </div>
      </div>
    </div>

    <div id="sheet">
      <div class="doc-header">
        <div class="doc-mark"><img src="https://upload.wikimedia.org/wikipedia/commons/0/00/Bras%C3%A3o_da_ROTA.svg" alt="Brasão da ROTA"></div>
        <div>
          <h2 class="doc-title">ROTA • Relatório de Serviço Operacional</h2>
          <p class="doc-sub">Batalhão de Polícia de Choque — Documento gerado automaticamente</p>
        </div>
      </div>
      <hr class="doc-rule">
      <div class="meta"><span id="meta-data">Data/Hora: —</span><span id="meta-rota">Rota: —</span></div>
      <div class="section"><h3>EFETIVO</h3>
        <div class="kv">
          <b>Motorista:</b><span id="k-motorista">—</span>
          <b>Encarregado:</b><span id="k-encarregado">—</span>
          <b>Segurança:</b><span id="k-seguranca">—</span>
          <b>Auxiliar:</b><span id="k-auxiliares">—</span>
        </div>
      </div>
      <div class="section"><h3>ILÍCITOS</h3><ul class="clean" id="ul-ilicitos"><li>—</li></ul></div>
      <div class="section"><h3>VEÍCULOS</h3><ul class="clean" id="ul-veiculos"><li>—</li></ul></div>
      <div class="section"><h3>OCORRÊNCIAS</h3><ul class="clean" id="ul-ocorrencias"><li>—</li></ul></div>
      <div class="section"><h3>ABORDADOS</h3><ul class="clean" id="ul-abordados"><li>—</li></ul></div>
      <div class="section"><h3>RESULTADO</h3><ul class="clean" id="ul-resultado"><li>0x Ocorrência.</li><li>0x Apoio.</li><li>0x Ação.</li></ul></div>
      <hr class="footer-rule"><div class="doc-footer"><div>RSO • ROTA</div><div id="rodape-data">—</div></div>
    </div>
  </div>

<script>
  // === Supabase Config ===
  const SUPABASE_URL = 'https://ilonwkgtdszmpcjwlezc.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsb253a2d0ZHN6bXBjandsZXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzQxMDIsImV4cCI6MjA3NTU1MDEwMn0.Cc-BtnHlXaGVCY6T6iXe0QA1tsfc17aX8lswEICvtw0';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = id => document.getElementById(id);
  const pad2 = n => String(n).padStart(2,'0');
  const esc = s => (s||'').replace(/[&<>\"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]));

  let RANKS = [];
  let OFFICERS = [];
  const NAME_SELECTS = ['motorista_sel','encarregado_sel','seguranca_sel','auxiliares_sel'];
  const RANK_SELECTS = ['motorista_rank','encarregado_rank','seguranca_rank','auxiliares_rank'];

  async function loadRanks(){
    const { data, error } = await supa.from('ranks').select('id,name,sort_order').order('sort_order', { ascending: true });
    if(error){ console.error(error); alert('Erro ao carregar patentes.'); return; }
    RANKS = data || [];
    RANK_SELECTS.forEach(id => fillRankSelect(id));
  }
  function fillRankSelect(id){
    const sel = $(id);
    sel.innerHTML = `<option value=\"\">Selecione a patente…</option>` + RANKS.map(r => `<option value=\"${r.id}\">${esc(r.name)}</option>`).join('');
  }

  async function loadOfficers(){
    const { data, error } = await supa.from('officers').select('id,name,current_rank_id').eq('active', true).order('name');
    if(error){ console.error(error); alert('Erro ao carregar policiais.'); return; }
    OFFICERS = data || [];
    NAME_SELECTS.forEach(id => fillOfficerSelect(id));
  }
  function fillOfficerSelect(id){
    const sel = $(id);
    sel.innerHTML = `<option value=\"\">Selecione…</option>` + OFFICERS.map(o => `<option value=\"${esc(o.id)}\">${esc(o.name)}</option>`).join('');
  }

  function linkNameToRank(){
    NAME_SELECTS.forEach((nameId, idx) => {
      const rankId = RANK_SELECTS[idx];
      $(nameId).addEventListener('change', (e) => {
        const val = e.target.value;
        const off = OFFICERS.find(o => o.id === val);
        $(rankId).value = off?.current_rank_id || '';
      });
    });
  }

  (async function initRoster(){
    await loadRanks();
    await loadOfficers();
    linkNameToRank();
  })();

  (function(){
    const d=new Date(), z=n=>String(n).padStart(2,'0');
    $('datahora').value = `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`;
  })();

  function mkItem(id,v,ph){const w=document.createElement('div');w.className='item';w.innerHTML=`<input placeholder=\"${ph}\" value=\"${v}\"><button class=\"btn btn-sec\" type=\"button\">remover</button>`;w.querySelector('button').onclick=()=>w.remove();$(id).appendChild(w);}
  function addIlicito(v=''){mkItem('list-ilicitos',v,'ex.: 02x Maconha');}
  function addVeiculo(v=''){mkItem('list-veiculos',v,'ex.: BMW R1250 HP - Branca - 57URU265');}
  function addAbordado(v=''){mkItem('list-abordados',v,'ex.: Renato Cruz – 4910 – BOPM – Cb Ducati');}
  function addOcorrencia(h='',t=''){const w=document.createElement('div');w.className='item-2';w.innerHTML=`<input type=\"time\" value=\"${h}\"><input placeholder=\"Descreva a ocorrência\" value=\"${t}\"><button class=\"btn btn-sec\" type=\"button\">remover</button>`;w.querySelector('button').onclick=()=>w.remove();$('list-ocorrencias').appendChild(w);}
  if(!$('list-ilicitos').children.length) addIlicito();
  if(!$('list-veiculos').children.length) addVeiculo();
  if(!$('list-ocorrencias').children.length) addOcorrencia();
  if(!$('list-abordados').children.length) addAbordado();

  function collect(){
    const L=id=>[...$(id).querySelectorAll('input')].map(i=>i.value).filter(Boolean);
    const O=[...$('list-ocorrencias').children].map(d=>{const [h,t]=d.querySelectorAll('input');return{h:h.value,t:t.value}}).filter(o=>o.t
