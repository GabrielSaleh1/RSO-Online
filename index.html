<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f16" />
  <title>ROTA ‚Ä¢ Relat√≥rio de Servi√ßo Operacional</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg0:#070a10;
      --bg1:#0b0f16;
      --card:#111827;
      --card2:#0f172a;
      --stroke:rgba(148,163,184,.18);

      --gold:#f59e0b;
      --gold2:#fbbf24;
      --gold700:#b45309;

      --red:#ef4444;
      --green:#10b981;

      --text:#e5e7eb;
      --sub:#94a3b8;
    }

    html,body{min-height:100%; color:var(--text); background:
      radial-gradient(1200px 900px at 15% 10%, rgba(245,158,11,.10), transparent 55%),
      radial-gradient(1100px 800px at 85% 20%, rgba(239,68,68,.07), transparent 58%),
      radial-gradient(900px 700px at 70% 95%, rgba(16,185,129,.06), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* grid suave (sem m√°scara pra n√£o ‚Äúcortar‚Äù) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.22;
      background-image:
        linear-gradient(rgba(148,163,184,.10) 1px, transparent 1px),
        linear-gradient(90deg, rgba(148,163,184,.10) 1px, transparent 1px);
      background-size: 72px 72px;
      z-index:0;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background: radial-gradient(closest-side at 50% 35%, transparent 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.55) 100%);
      z-index:0;
    }
    #appRoot{ position:relative; z-index:1; }

    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }

    .rota-card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.14)), var(--card);
      border:1px solid rgba(245,158,11,.14);
      border-radius: 1.25rem;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    .soft{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10)), var(--card2);
      border:1px solid var(--stroke);
      border-radius: 1.25rem;
    }

    .badge{
      font-size:.75rem;
      padding:.28rem .6rem;
      border-radius: 999px;
      border:1px solid rgba(245,158,11,.25);
      background: rgba(245,158,11,.12);
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      white-space:nowrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.55rem;
      font-weight:800;
      border-radius: 1rem;
      padding:.72rem 1.05rem;
      border:1px solid transparent;
      transition: transform .06s ease, background-color .2s ease, border-color .2s ease, opacity .2s ease;
      user-select:none;
      will-change: transform;
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .btn-gold{ background: var(--gold); color:#081018; border-color: rgba(180,83,9,.85); }
    .btn-gold:hover{ background: var(--gold2); }
    .btn-red{ background: var(--red); color:#fff; border-color: rgba(185,28,28,.9); }
    .btn-red:hover{ background: #f87171; }
    .btn-ghost{ background: rgba(148,163,184,.06); color: var(--text); border-color: rgba(148,163,184,.22); }
    .btn-ghost:hover{ background: rgba(148,163,184,.10); }
    .btn-outline{ background: transparent; color: var(--text); border-color: rgba(148,163,184,.30); }
    .btn-outline:hover{ background: rgba(148,163,184,.08); }

    input, select{
      background: rgba(2,6,23,.55) !important;
      border: 1px solid rgba(148,163,184,.30) !important;
      border-radius: 1rem !important;
      padding: .70rem .95rem !important;
      color: var(--text) !important;
      outline: none !important;
    }
    input::placeholder{ color: rgba(148,163,184,.85) !important; }
    input:focus, select:focus{
      box-shadow: 0 0 0 3px rgba(245,158,11,.22) !important;
      border-color: rgba(245,158,11,.55) !important;
    }

    .section-title{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom: .85rem;
    }
    .section-title h2, .section-title h3{
      margin:0;
    }

    /* === IMPRESS√ÉO A4 (mantido do seu original) === */
    @page { size: A4; margin: 14mm }
    @media print {
      :root { --ink:#0b1220; --ink-soft:#334155; --line:#dbe3ee; --bg:#ffffff; --bg-soft:#f8fafc; --chip:#eef2ff; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      html, body { background: var(--bg) !important; color: var(--ink) !important; }

      body::before, body::after, #appRoot header, #form-area { display:none !important; }

      #sheet {
        display: block !important;
        width: 190mm; max-width: 190mm; margin: 0 auto;
        background: var(--bg) !important; color: var(--ink) !important;
        border: 1px solid var(--line) !important; border-radius: 10px;
        box-shadow: none !important;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        font-size: 13.25px; line-height: 1.38;
        padding: 18mm 16mm;
      }

      #sheet .doc-head { display: grid; grid-template-columns: 44px 1fr; gap: 10px; align-items: center; margin-bottom: 8px; }
      #sheet .logo { width: 44px; height: 44px; display: grid; place-items: center; border-radius: 10px; border: 1px solid var(--ink-soft); color: var(--ink); font-weight: 800; }
      #sheet .title { font-size: 17px; font-weight: 800; color: var(--ink); margin: 0; }
      #sheet .subtitle { font-size: 11px; color: var(--ink-soft); margin-top: 1px; }

      #sheet .meta { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 12px; }
      #sheet .chip { border: 1px solid var(--line); background: var(--bg-soft); color: var(--ink-soft); font-size: 11px; padding: 4px 8px; border-radius: 999px; }

      #sheet .divider { height: 1px; background: var(--line); margin: 10px 0 14px; }
      #sheet .section { background: var(--bg); border: 1px solid var(--line); border-radius: 8px; padding: 10px 12px; margin-bottom: 10px; }
      #sheet .section h3 { font-size: 13.5px; margin: 0 0 6px; color: var(--ink); font-weight: 700; border-bottom: 1px solid var(--line); padding-bottom: 6px; }

      #sheet .kgrid { display: grid; grid-template-columns: 130px 1fr; column-gap: 10px; row-gap: 4px; font-size: 12.75px; }
      #sheet .kgrid b { color: var(--ink-soft); }

      #sheet ul { list-style: disc; padding-left: 18px; margin: 6px 0; }
      #sheet li { line-height: 1.32; }

      #sheet .result ul { list-style: none; padding: 0; margin: 0; }
      #sheet .result li { display:flex; gap:8px; }
      #sheet .result li::before { content:"‚Ä¢"; color: var(--ink-soft); }

      #sheet .foot { margin-top: 12px; display:flex; justify-content:space-between; align-items:center; font-size: 11px; color: var(--ink-soft); border-top: 1px solid var(--line); padding-top: 8px; }
    }
  </style>
</head>

<body class="min-h-screen">
  <div id="appRoot" class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">

    <!-- Header -->
    <header class="glass rounded-3xl p-5 sm:p-6 mb-6">
      <div class="flex items-center gap-4 flex-wrap">
        <div class="relative">
          <div class="h-11 w-11 rounded-2xl grid place-items-center rota-card text-xl font-black">R</div>
          <span class="absolute -right-1 -bottom-1 h-4 w-4 rounded-full bg-amber-500 ring-2 ring-black/50"></span>
        </div>

        <div class="min-w-[240px]">
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-wide">ROTA ‚Ä¢ Relat√≥rio de Servi√ßo Operacional</h1>
          <p class="text-sm text-slate-300/75">Batalh√£o de Pol√≠cia de Choque ‚Äî Documento interno</p>
        </div>

        <div class="ml-auto flex items-center gap-2 flex-wrap">
          <span class="badge">üìÑ RSO</span>
          <span class="badge">üßæ PDF/A4</span>
          <span class="badge">‚òÅÔ∏è Supabase</span>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-3">
        <div class="badge" style="border-color:rgba(148,163,184,.25); background:rgba(148,163,184,.06)">
          ‚úÖ Layout atualizado (mais limpo e r√°pido)
        </div>
        <div class="ml-auto text-xs text-slate-300/70">
          Dica: preencha e clique em <b>Imprimir / PDF</b> para gerar a folha A4.
        </div>
      </div>
    </header>

    <!-- Formul√°rio (com layout melhor no desktop) -->
    <div id="form-area" class="grid gap-6 lg:grid-cols-12 items-start">

      <!-- Coluna principal -->
      <div class="lg:col-span-8 space-y-6">

        <!-- Meta -->
        <section class="rota-card p-5 sm:p-6">
          <div class="section-title">
            <h2 class="text-lg sm:text-xl font-extrabold">üóìÔ∏è Identifica√ß√£o</h2>
            <span class="badge" style="background:rgba(148,163,184,.06);border-color:rgba(148,163,184,.22)">Campos obrigat√≥rios</span>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-300/80 mb-1">Data/Hora</label>
              <input id="datahora" type="datetime-local" class="w-full" />
            </div>
            <div>
              <label class="block text-sm text-slate-300/80 mb-1">Rota</label>
              <input id="rota" placeholder="91136" class="w-full" />
            </div>
          </div>
        </section>

        <!-- Efetivo -->
        <section class="rota-card p-5 sm:p-6">
          <div class="section-title">
            <h2 class="text-lg sm:text-xl font-extrabold">üßë‚Äç‚úàÔ∏è Efetivo</h2>
            <span class="badge" style="background:rgba(245,158,11,.10)">Selecione policial + patente</span>
          </div>

          <div class="space-y-5">
            <div>
              <label class="block text-sm text-slate-300/80 mb-2">Motorista(s)</label>
              <div id="list-motorista" class="space-y-3"></div>
              <button type="button" class="btn btn-ghost mt-3" onclick="addTeamItem('motorista')">‚ûï adicionar motorista</button>
            </div>

            <div>
              <label class="block text-sm text-slate-300/80 mb-2">Chefe de barca / Encarregado(s)</label>
              <div id="list-encarregado" class="space-y-3"></div>
              <button type="button" class="btn btn-ghost mt-3" onclick="addTeamItem('encarregado')">‚ûï adicionar chefe de barca</button>
            </div>

            <div>
              <label class="block text-sm text-slate-300/80 mb-2">Seguran√ßa(s)</label>
              <div id="list-seguranca" class="space-y-3"></div>
              <button type="button" class="btn btn-ghost mt-3" onclick="addTeamItem('seguranca')">‚ûï adicionar seguran√ßa</button>
            </div>

            <div>
              <label class="block text-sm text-slate-300/80 mb-2">Auxiliar(es)</label>
              <div id="list-auxiliares" class="space-y-3"></div>
              <button type="button" class="btn btn-ghost mt-3" onclick="addTeamItem('auxiliares')">‚ûï adicionar auxiliar</button>
            </div>
          </div>
        </section>

        <!-- Blocos -->
        <section class="grid gap-6">
          <div class="rota-card p-5 sm:p-6">
            <div class="section-title">
              <h3 class="text-lg font-extrabold">üßç Abordados</h3>
              <span class="text-xs text-slate-300/70">Nome ‚Ä¢ CPF/ID ‚Ä¢ Situa√ß√£o</span>
            </div>
            <div id="list-abordados" class="space-y-3"></div>
            <button type="button" class="btn btn-ghost w-full justify-center mt-3" onclick="addAbordado()">‚ûï adicionar abordado</button>
          </div>

          <div class="rota-card p-5 sm:p-6">
            <div class="section-title">
              <h3 class="text-lg font-extrabold">üö´ Il√≠citos</h3>
              <span class="text-xs text-slate-300/70">ex.: 02x Maconha</span>
            </div>
            <div id="list-ilicitos" class="space-y-3"></div>
            <button type="button" class="btn btn-ghost w-full justify-center mt-3" onclick="addIlicito()">‚ûï adicionar il√≠cito</button>
          </div>

          <div class="rota-card p-5 sm:p-6">
            <div class="section-title">
              <h3 class="text-lg font-extrabold">üöó Ve√≠culos</h3>
              <span class="text-xs text-slate-300/70">Modelo ‚Ä¢ Cor ‚Ä¢ Placa ‚Ä¢ Situa√ß√£o</span>
            </div>
            <div id="list-veiculos" class="space-y-3"></div>
            <button type="button" class="btn btn-ghost w-full justify-center mt-3" onclick="addVeiculo()">‚ûï adicionar ve√≠culo</button>
          </div>

          <div class="rota-card p-5 sm:p-6">
            <div class="section-title">
              <h3 class="text-lg font-extrabold">üìå Ocorr√™ncias</h3>
              <span class="text-xs text-slate-300/70">Hora + descri√ß√£o</span>
            </div>
            <div id="list-ocorrencias" class="space-y-3"></div>
            <button type="button" class="btn btn-ghost w-full justify-center mt-3" onclick="addOcorrencia()">‚ûï adicionar ocorr√™ncia</button>
          </div>
        </section>

        <!-- Resultado -->
        <section class="rota-card p-5 sm:p-6">
          <div class="section-title">
            <h3 class="text-lg font-extrabold">üìà Resultado</h3>
            <span class="badge" style="background:rgba(148,163,184,.06);border-color:rgba(148,163,184,.22)">Somat√≥rio</span>
          </div>

          <div class="grid sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-slate-300/80 mb-1">Ocorr√™ncias (qtd)</label>
              <input id="res-oc" type="number" min="0" value="0" class="w-full" />
            </div>
            <div>
              <label class="block text-sm text-slate-300/80 mb-1">Apoios (qtd)</label>
              <input id="res-ap" type="number" min="0" value="0" class="w-full" />
            </div>
            <div>
              <label class="block text-sm text-slate-300/80 mb-1">A√ß√µes (Blipadas)</label>
              <input id="res-ac" type="number" min="0" value="0" class="w-full" />
            </div>
          </div>
        </section>

      </div>

      <!-- Coluna lateral -->
      <aside class="lg:col-span-4 space-y-6 lg:sticky lg:top-6">

        <!-- A√ß√µes -->
        <section class="rota-card p-5 sm:p-6">
          <div class="section-title">
            <h3 class="text-lg font-extrabold">‚öôÔ∏è A√ß√µes</h3>
            <span class="badge" style="background:rgba(148,163,184,.06);border-color:rgba(148,163,184,.22)">Atalhos</span>
          </div>

          <div class="grid gap-3">
            <button class="btn btn-gold w-full" id="saveCloudBtn" type="button">üíæ Salvar il√≠citos</button>
            <button class="btn btn-red w-full" id="printBtn" type="button">üßæ Imprimir / PDF</button>
            <button class="btn btn-ghost w-full" id="totalsBtn" type="button">üìä Totais 7 dias</button>
          </div>

          <div class="mt-4 soft p-4">
            <div class="text-xs text-slate-300/70">
              <b>Regras r√°pidas:</b>
              <ul class="list-disc pl-5 mt-2 space-y-1">
                <li>Preencha pelo menos 1 <b>Abordado</b> e 1 <b>Ve√≠culo</b> para imprimir.</li>
                <li>Para salvar no Supabase, selecione pelo menos 1 membro do <b>Efetivo</b>.</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- Totais -->
        <section id="totalsPanel" class="rota-card p-5 sm:p-6 hidden">
          <div class="flex items-center justify-between gap-3 mb-4 flex-wrap">
            <h3 class="text-lg font-extrabold">üìä Totais (7 dias)</h3>
            <div class="flex gap-2">
              <button class="btn btn-ghost" id="exportCsvBtn" type="button">Exportar CSV</button>
              <button class="btn btn-ghost" id="closeTotalsBtn" type="button">Fechar</button>
            </div>
          </div>
          <div id="totalsContent" class="space-y-4"></div>
        </section>

      </aside>
    </div>

    <!-- FOLHA A4 (print bonita) -->
    <div id="sheet" class="hidden">
      <div class="doc-head">
        <div class="logo">R</div>
        <div>
          <h2 class="title">ROTA ‚Ä¢ Relat√≥rio de Servi√ßo Operacional</h2>
          <div class="subtitle">Documento gerado automaticamente</div>
        </div>
      </div>

      <div class="meta">
        <span class="chip" id="meta-data">Data/Hora: ‚Äî</span>
        <span class="chip" id="meta-rota">Rota: ‚Äî</span>
      </div>

      <div class="divider"></div>

      <div class="section">
        <h3>Efetivo</h3>
        <div class="kgrid">
          <b>Motorista(s):</b><span id="k-motorista">‚Äî</span>
          <b>Encarregado(s):</b><span id="k-encarregado">‚Äî</span>
          <b>Seguran√ßa(s):</b><span id="k-seguranca">‚Äî</span>
          <b>Auxiliar(es):</b><span id="k-auxiliares">‚Äî</span>
        </div>
      </div>

      <div class="section">
        <h3>Abordados</h3>
        <ul id="ul-abordados"><li>‚Äî</li></ul>
      </div>

      <div class="section">
        <h3>Il√≠citos</h3>
        <ul id="ul-ilicitos"><li>‚Äî</li></ul>
      </div>

      <div class="section">
        <h3>Ve√≠culos</h3>
        <ul id="ul-veiculos"><li>‚Äî</li></ul>
      </div>

      <div class="section">
        <h3>Ocorr√™ncias</h3>
        <ul id="ul-ocorrencias"><li>‚Äî</li></ul>
      </div>

      <div class="section result">
        <h3>Resultado</h3>
        <ul id="ul-resultado">
          <li>0x Ocorr√™ncia.</li>
          <li>0x Apoio.</li>
          <li>0x A√ß√£o.</li>
        </ul>
      </div>

      <div class="foot">
        <div>RSO ‚Ä¢ ROTA</div>
        <div id="rodape-data">‚Äî</div>
      </div>
    </div>

  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /********** Helpers **********/
    const $ = id => document.getElementById(id);
    const pad2 = n => String(n).padStart(2,'0');
    const esc = s => (s||'').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

    const SUPABASE_URL = 'https://ilonwkgtdszmpcjwlezc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsb253a2d0ZHN6bXBjandsZXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzQxMDIsImV4cCI6MjA3NTU1MDEwMn0.Cc-BtnHlXaGVCY6T6iXe0QA1tsfc17aX8lswEICvtw0';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let RANKS = [], OFFICERS = [];
    let lastSavedIllicitHash = '';
    const ROLE_IDS = { motorista:'list-motorista', encarregado:'list-encarregado', seguranca:'list-seguranca', auxiliares:'list-auxiliares' };

    /********** UI builders **********/
    function mkItem(id,v,ph){
      const w=document.createElement('div'); w.className='item soft p-4';
      w.innerHTML=`
        <div class="grid gap-2">
          <input class="w-full" placeholder="${ph}" value="${v}">
          <div class="text-right">
            <button class="btn btn-ghost" type="button">remover</button>
          </div>
        </div>`;
      w.querySelector('button').onclick=()=>w.remove();
      $(id).appendChild(w);
    }
    function addIlicito(v=''){ mkItem('list-ilicitos',v,'ex.: 02x Maconha'); }

    function addOcorrencia(h='',t=''){
      const w=document.createElement('div'); w.className='item soft p-4';
      w.innerHTML=`
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input type="time" value="${h}">
          <input placeholder="Descreva a ocorr√™ncia" value="${t}" class="sm:col-span-2">
        </div>
        <div class="mt-3 text-right"><button class="btn btn-ghost" type="button">remover</button></div>`;
      w.querySelector('button').onclick=()=>w.remove();
      $('list-ocorrencias').appendChild(w);
    }

    function addAbordado(nome='',doc='',sit=''){
      const w=document.createElement('div'); w.className='item soft p-4';
      w.innerHTML=`
        <div class="grid md:grid-cols-3 gap-3 w-full">
          <input placeholder="Nome do abordado" value="${esc(nome)}">
          <input placeholder="CPF/ID do abordado" value="${esc(doc)}">
          <input placeholder="Situa√ß√£o (ex.: BOPM ‚Äî Cb Ducati 20:40)" value="${esc(sit)}">
        </div>
        <div class="mt-3 text-right"><button class="btn btn-ghost" type="button">remover</button></div>`;
      w.querySelector('button').onclick=()=>w.remove();
      $('list-abordados').appendChild(w);
    }

    function addVeiculo(modelo='',cor='',placa='',sit=''){
      const w=document.createElement('div'); w.className='item soft p-4';
      w.innerHTML=`
        <div class="grid md:grid-cols-4 gap-3 w-full">
          <input placeholder="Modelo do ve√≠culo" value="${esc(modelo)}">
          <input placeholder="Cor" value="${esc(cor)}">
          <input placeholder="Emplacamento" value="${esc(placa)}">
          <input placeholder="Situa√ß√£o (ex.: Apreendido)" value="${esc(sit)}">
        </div>
        <div class="mt-3 text-right"><button class="btn btn-ghost" type="button">remover</button></div>`;
      w.querySelector('button').onclick=()=>w.remove();
      $('list-veiculos').appendChild(w);
    }

    // Efetivo: select nome -> select patente
    function addTeamItem(role){
      const containerId = ROLE_IDS[role];
      const wrap = document.createElement('div'); wrap.className='item soft p-4';
      const inner=document.createElement('div'); inner.className='grid grid-cols-1 gap-3';

      const nameSel=document.createElement('select');
      const rankSel=document.createElement('select');
      nameSel.className='w-full';
      rankSel.className='w-full';

      nameSel.innerHTML = `<option value="">Selecione o policial‚Ä¶</option>` + OFFICERS.map(o=>`<option value="${o.id}">${esc(o.name)}</option>`).join('');
      rankSel.innerHTML = `<option value="">Selecione a patente‚Ä¶</option>` + RANKS.map(r=>`<option value="${r.id}">${esc(r.name)}</option>`).join('');

      nameSel.addEventListener('change', e=>{
        const off = OFFICERS.find(o=>o.id===e.target.value);
        if(off) rankSel.value = off.current_rank_id ?? '';
      });

      inner.appendChild(nameSel); inner.appendChild(rankSel);

      const actions=document.createElement('div'); actions.className='mt-2 text-right';
      const del=document.createElement('button'); del.type='button'; del.className='btn btn-ghost'; del.textContent='remover';
      del.onclick=()=>wrap.remove(); actions.appendChild(del);

      wrap.appendChild(inner); wrap.appendChild(actions);
      $(containerId).appendChild(wrap);
    }

    /********** Coleta/Impress√£o **********/
    function collectRole(role){
      const items=[...($(ROLE_IDS[role])?.querySelectorAll('.item')||[])], out=[];
      items.forEach(it=>{
        const [nameSel, rankSel] = it.querySelectorAll('select');
        const officerId = nameSel?.value || ''; const rankId = rankSel?.value || '';
        if(!officerId) return;
        const off = OFFICERS.find(o=>o.id===officerId);
        const rk  = RANKS.find(r=>String(r.id)===String(rankId));
        out.push({name: off?.name || '', rank_name: rk?.name || '', label:`${rk?.name?rk.name+' ':''}${off?.name||''}`.trim()});
      });
      return out;
    }
    function collect(){
      const L=id=>[...$(id).querySelectorAll('input')].map(i=>i.value).filter(Boolean);
      const O=[...$('list-ocorrencias').children].map(d=>{const ins=d.querySelectorAll('input');return{h:ins[0]?.value,t:ins[1]?.value}}).filter(o=>o.t);

      const motoristaArr=collectRole('motorista'), encarregadoArr=collectRole('encarregado'),
            segurancaArr=collectRole('seguranca'), auxiliaresArr=collectRole('auxiliares');

      const AB=[...$('list-abordados').children].map(w=>{
        const [n,d,s]=w.querySelectorAll('input'); return {nome:n?.value.trim(),doc:d?.value.trim(),sit:s?.value.trim()};
      }).filter(x=>x && (x.nome||x.doc||x.sit));
      const abordadosFmt = AB.map(x=>`${x.nome} ‚Äî ${x.doc} ‚Äî ${x.sit}`);

      const VV=[...$('list-veiculos').children].map(w=>{
        const [m,c,p,s]=w.querySelectorAll('input'); return {modelo:m?.value.trim(),cor:c?.value.trim(),placa:p?.value.trim(),sit:s?.value.trim()};
      }).filter(x=>x && (x.modelo||x.cor||x.placa||x.sit));
      const veiculosFmt = VV.map(x=>`${x.modelo} ‚Äî ${x.cor} ‚Äî ${x.placa} ‚Äî ${x.sit}`);

      return {
        datahora:$('datahora').value, rota:$('rota').value,
        motorista:motoristaArr.map(x=>x.label),
        encarregado:encarregadoArr.map(x=>x.label),
        seguranca:segurancaArr.map(x=>x.label),
        auxiliares:auxiliaresArr.map(x=>x.label),
        _pairs:[...motoristaArr,...encarregadoArr,...segurancaArr,...auxiliaresArr],
        ilicitos:L('list-ilicitos'), veiculos:veiculosFmt, ocorrencias:O, abordados:abordadosFmt,
        resOc:+($('res-oc').value||0), resAp:+($('res-ap').value||0), resAc:+($('res-ac').value||0)
      };
    }
    function fillSheet(d){
      const dt=d.datahora?new Date(d.datahora):new Date();
      const dd=`${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
      const metaData = document.getElementById('meta-data');
      const metaRota = document.getElementById('meta-rota');
      if(metaData) metaData.textContent = `Data/Hora: ${dd}`;
      if(metaRota) metaRota.textContent = `Rota: ${d.rota || '‚Äî'}`;

      const joinOrDash = a => (a&&a.length)?esc(a.join(' | ')):'‚Äî';
      $('k-motorista').innerHTML=joinOrDash(d.motorista);
      $('k-encarregado').innerHTML=joinOrDash(d.encarregado);
      $('k-seguranca').innerHTML=joinOrDash(d.seguranca);
      $('k-auxiliares').innerHTML=joinOrDash(d.auxiliares);

      const setList=(id,a)=>{const u=$(id); u.innerHTML=''; if(!a||!a.length){u.innerHTML='<li>‚Äî</li>';return} a.forEach(v=>{const li=document.createElement('li'); li.innerHTML=esc(v); u.appendChild(li);});};
      setList('ul-abordados',d.abordados); setList('ul-ilicitos',d.ilicitos); setList('ul-veiculos',d.veiculos);

      const ulO=$('ul-ocorrencias'); ulO.innerHTML='';
      if(!d.ocorrencias.length) ulO.innerHTML='<li>‚Äî</li>';
      else { d.ocorrencias.sort((a,b)=>(a.h||'').localeCompare(b.h||'')); d.ocorrencias.forEach(o=>{const li=document.createElement('li'); li.innerHTML=esc(o.h?`√ÄS ${o.h}: ${o.t}`:o.t); ulO.appendChild(li);}); }

      $('ul-resultado').innerHTML=`<li>${d.resOc}x Ocorr√™ncia.</li><li>${d.resAp}x Apoio.</li><li>${d.resAc}x A√ß√£o.</li>`;
      const now=new Date(); $('rodape-data').textContent=`Emitido em ${pad2(now.getDate())}/${pad2(now.getMonth()+1)}/${now.getFullYear()} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
    }

    /********** Supabase I/O **********/
    async function loadRanks(){ const {data,error}=await supa.from('ranks').select('id,name,sort_order').order('sort_order'); if(!error) RANKS=data||[]; }
    async function loadOfficers(){ const {data,error}=await supa.from('officers').select('id,name,current_rank_id').eq('active',true).order('name'); if(!error) OFFICERS=data||[]; }

    function parseIlicitosText(multiline){
      const parts=(multiline||'').split(/\n|,|;/).map(s=>s.trim()).filter(Boolean), out=[];
      for(const p of parts){
        let m=p.match(/^(\d+)\s*[x√ó]?\s*(.+)$/i)||p.match(/^(\d+)\s+(.+)$/i);
        if(m){ out.push({item:m[2].trim().toLowerCase(), qty:parseInt(m[1],10)}); continue; }
        const m2=p.match(/(\d+)/); if(m2){ out.push({item:p.replace(m2[0],'').trim().toLowerCase()||'desconhecido', qty:parseInt(m2[1],10)}); }
        else out.push({item:p.toLowerCase(), qty:1});
      }
      return out;
    }
    function selectedOfficerAndRankPairs(){ const d=collect(); return (d._pairs||[]).map(p=>({name:p.name, rank_name:p.rank_name})); }

    async function saveIllicitsToSupabase(){
      const rota = ($('rota').value||'').trim()||null;
      const lines = [...document.querySelectorAll('#list-ilicitos input')].map(i=>i.value).filter(Boolean).join('\n');
      const items = parseIlicitosText(lines);
      const pairs = selectedOfficerAndRankPairs();
      if(!items.length){ alert('Preencha ao menos 1 il√≠cito.'); return; }
      if(!pairs.length){ alert('Selecione pelo menos 1 membro de equipe (nome e patente).'); return; }

      const rows = pairs.flatMap(({name,rank_name})=> items.map(({item,qty})=>({
        officer:name, rank_at_time:rank_name, rota, item_type:item, quantity:Number(qty)
      })));

      const btn=$('saveCloudBtn'); const old=btn.textContent; btn.textContent='Salvando‚Ä¶'; btn.disabled=true;
      try{
        const { error } = await supa.from('rso_items').insert(rows);
        if(error) throw error;
        btn.textContent='Salvo!'; lastSavedIllicitHash = String(lines);
      }catch(e){ console.error(e); alert('Falha ao salvar no Supabase.'); }
      finally{ setTimeout(()=>{ btn.textContent=old; btn.disabled=false; }, 1200); }
    }

    async function showTotals7d(){
      const cutoff = new Date(Date.now()-7*24*60*60*1000).toISOString();
      const { data, error } = await supa.from('rso_items')
        .select('officer,item_type,quantity,recorded_at')
        .gte('recorded_at', cutoff);

      if(error){ alert('Erro ao buscar totais.'); return; }

      const agg = {};
      (data||[]).forEach(r=>{
        const off = r.officer || '‚Äî';
        if(!agg[off]) agg[off] = {};
        agg[off][r.item_type] = (agg[off][r.item_type] || 0) + Number(r.quantity || 0);
      });
      renderTotals(agg);
    }

    function renderTotals(agg){
      const panel = $('totalsPanel');
      const content = $('totalsContent');
      if(!agg || !Object.keys(agg).length){
        content.innerHTML = '<div class="text-slate-300/70 text-sm">Sem dados nos √∫ltimos 7 dias.</div>';
        panel.classList.remove('hidden');
        return;
      }
      let html = '';
      Object.keys(agg).sort().forEach(off=>{
        html += `<div class="soft p-4">
          <h4 class="font-extrabold mb-3">${esc(off)}</h4>
          <div class="overflow-x-auto">
            <table class="w-full text-sm border border-slate-300/20 rounded-xl overflow-hidden">
              <thead>
                <tr class="bg-white/5">
                  <th class="text-left p-2.5 text-slate-200/90">Item</th>
                  <th class="text-right p-2.5 text-slate-200/90">Quantidade</th>
                </tr>
              </thead>
              <tbody>`;
        const items = agg[off];
        Object.keys(items).sort().forEach(it=>{
          html += `<tr class="odd:bg-white/0 even:bg-white/5">
            <td class="p-2.5">${esc(it)}</td>
            <td class="p-2.5 text-right font-bold text-amber-300">${items[it]}</td>
          </tr>`;
        });
        html += `</tbody></table></div></div>`;
      });
      content.innerHTML = html;
      panel.classList.remove('hidden');
    }

    function exportTotalsCSVFromAgg(agg){
      const rows = [['policial','item','total']];
      Object.entries(agg).forEach(([off, items])=>{
        Object.entries(items).forEach(([item, total])=> rows.push([off,item,total]));
      });
      const escCSV = s => /[\"",;\n]/.test(String(s)) ? `"${String(s).replace(/"/g,'""')}"` : s;
      const csv = rows.map(r=>r.map(escCSV).join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='RSO-totais-7dias.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function validateStructured(){
      const abordados=[...$('list-abordados').children], veiculos=[...$('list-veiculos').children];
      if(!abordados.length){ alert('Adicione pelo menos 1 Abordado.'); return false; }
      if(!veiculos.length){ alert('Adicione pelo menos 1 Ve√≠culo.'); return false; }
      for(const w of abordados){ const ins=[...w.querySelectorAll('input')]; if(ins.some(i=>!i.value.trim())){ alert('Preencha todos os campos de Abordados.'); return false; } }
      for(const w of veiculos){ const ins=[...w.querySelectorAll('input')]; if(ins.some(i=>!i.value.trim())){ alert('Preencha todos os campos de Ve√≠culos.'); return false; } }
      return true;
    }

    /********** Init **********/
    document.addEventListener('DOMContentLoaded', async ()=>{
      // Data default
      const d=new Date(), z=n=>String(n).padStart(2,'0');
      $('datahora').value=`${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`;

      // Carregar selects
      await Promise.all([loadRanks(), loadOfficers()]);

      // Itens iniciais
      addTeamItem('motorista'); addTeamItem('encarregado'); addTeamItem('seguranca'); addTeamItem('auxiliares');
      addAbordado(); addVeiculo(); addIlicito(); addOcorrencia();

      // Bot√µes de a√ß√£o
      $('saveCloudBtn').addEventListener('click', saveIllicitsToSupabase);
      $('totalsBtn').addEventListener('click', showTotals7d);
      $('closeTotalsBtn').addEventListener('click', ()=> $('totalsPanel').classList.add('hidden'));
      $('exportCsvBtn').addEventListener('click', ()=>{
        const agg = {};
        [...$('totalsContent').children].forEach(group=>{
          const officer = group.querySelector('h4')?.textContent?.trim() || '‚Äî';
          agg[officer] = {};
          group.querySelectorAll('tbody tr').forEach(tr=>{
            const [tdItem, tdQty] = tr.querySelectorAll('td');
            if(tdItem && tdQty) agg[officer][tdItem.textContent.trim()] = Number(tdQty.textContent.trim())||0;
          });
        });
        exportTotalsCSVFromAgg(agg);
      });

      $('printBtn').addEventListener('click', ()=>{
        if(!validateStructured()) return;
        const d=collect(); fillSheet(d); window.print();
      });

      // Expor fun√ß√µes usadas por onclick
      Object.assign(window,{ addTeamItem, addAbordado, addIlicito, addVeiculo, addOcorrencia });
    });
  </script>
</body>
</html>
