<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f16" />
  <title>ROTA • Relatório de Serviço Operacional</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --rota-bg:#0b0f16; --rota-card:#121826; --rota-soft:#1a2235;
      --rota-gold:#f59e0b; --rota-gold-700:#b45309; --rota-red:#ef4444;
      --rota-green:#10b981; --rota-text:#e5e7eb; --rota-sub:#94a3b8;
    }
    html,body{background:var(--rota-bg);color:var(--rota-text)}
    .rota-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.04)),var(--rota-card);border:1px solid rgba(245,158,11,.12);border-radius:1rem}
    .tactical-band{position:relative;overflow:hidden;background:linear-gradient(120deg,rgba(245,158,11,.16) 0,rgba(245,158,11,0) 60%),var(--rota-soft);border:1px solid rgba(245,158,11,.2)}
    .tactical-band:after{content:"";position:absolute;inset:-40% -30%;background:repeating-linear-gradient(135deg,rgba(239,68,68,.22) 0 10px,rgba(239,68,68,0) 10px 22px);transform:rotate(-2deg);pointer-events:none;mix-blend-mode:overlay}
    .badge{font-size:.75rem;padding:.25rem .5rem;border-radius:.5rem;border:1px solid rgba(245,158,11,.25);background:rgba(245,158,11,.12);display:inline-block}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;font-weight:600;border-radius:.75rem;padding:.65rem 1rem;border:1px solid transparent;transition:.2s}
    .btn:active{transform:translateY(1px)}
    .btn-gold{background:var(--rota-gold);color:#0b0f16;border-color:var(--rota-gold-700)}
    .btn-gold:hover{background:#fbbf24}
    .btn-red{background:var(--rota-red);color:#fff;border-color:#b91c1c}
    .btn-red:hover{background:#f87171}
    .btn-ghost{background:transparent;color:var(--rota-text);border-color:rgba(148,163,184,.25)}
    .btn-ghost:hover{background:rgba(148,163,184,.08)}

    /* === IMPRESSÃO A4 – tema claro, cards e tipografia refinada === */
    @page { size: A4; margin: 14mm }
    @media print {
      :root { --ink:#0b1220; --ink-soft:#334155; --line:#dbe3ee; --bg:#ffffff; --bg-soft:#f8fafc; --chip:#eef2ff; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      html, body { background: var(--bg) !important; color: var(--ink) !important; }

      /* mostrar só a folha branca */
      #form-area, .tactical-band, .badge { display: none !important; }

      #sheet {
        display: block !important;
        width: 190mm; max-width: 190mm; margin: 0 auto;
        background: var(--bg) !important; color: var(--ink) !important;
        border: 1px solid var(--line) !important; border-radius: 10px;
        box-shadow: none !important;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        font-size: 13.25px; line-height: 1.38;
        padding: 18mm 16mm;
      }

      /* cabeçalho do documento */
      #sheet .doc-head {
        display: grid; grid-template-columns: 44px 1fr; gap: 10px; align-items: center;
        margin-bottom: 8px;
      }
      #sheet .logo {
        width: 44px; height: 44px; display: grid; place-items: center;
        border-radius: 10px; border: 1px solid var(--ink-soft); color: var(--ink);
        font-weight: 800;
      }
      #sheet .title { font-size: 17px; font-weight: 800; color: var(--ink); margin: 0; }
      #sheet .subtitle { font-size: 11px; color: var(--ink-soft); margin-top: 1px; }

      /* chips/meta */
      #sheet .meta { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 12px; }
      #sheet .chip {
        border: 1px solid var(--line); background: var(--bg-soft); color: var(--ink-soft);
        font-size: 11px; padding: 4px 8px; border-radius: 999px;
      }

      /* divisores e seções */
      #sheet .divider { height: 1px; background: var(--line); margin: 10px 0 14px; }
      #sheet .section {
        background: var(--bg); border: 1px solid var(--line); border-radius: 8px;
        padding: 10px 12px; margin-bottom: 10px;
      }
      #sheet .section h3 {
        font-size: 13.5px; margin: 0 0 6px; color: var(--ink); font-weight: 700;
        border-bottom: 1px solid var(--line); padding-bottom: 6px;
      }

      /* efetivo em duas colunas: label / valor */
      #sheet .kgrid {
        display: grid; grid-template-columns: 130px 1fr; column-gap: 10px; row-gap: 4px;
        font-size: 12.75px;
      }
      #sheet .kgrid b { color: var(--ink-soft); }

      /* listas */
      #sheet ul { list-style: disc; padding-left: 18px; margin: 6px 0; }
      #sheet li { line-height: 1.32; }

      /* resultado com marcadores alinhados */
      #sheet .result ul { list-style: none; padding: 0; margin: 0; }
      #sheet .result li { display:flex; gap:8px; }
      #sheet .result li::before { content:"•"; color: var(--ink-soft); }

      /* rodapé */
      #sheet .foot {
        margin-top: 12px; display:flex; justify-content:space-between; align-items:center;
        font-size: 11px; color: var(--ink-soft);
        border-top: 1px solid var(--line); padding-top: 8px;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <header class="tactical-band rounded-2xl p-5 mb-6">
      <div class="flex items-center gap-4 flex-wrap">
        <div class="h-10 w-10 rounded-xl flex items-center justify-center rota-card ring-1 ring-amber-500/30 text-xl font-black">R</div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-wide">ROTA • Relatório de Serviço Operacional</h1>
          <p class="text-sm text-slate-400">Batalhão de Polícia de Choque — Documento interno</p>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <span class="badge">Layout Ponto-Online</span>
          <span class="badge">RSO</span>
        </div>
      </div>
    </header>

    <!-- Formulário -->
    <div id="form-area" class="space-y-4">
      <!-- Meta -->
      <section class="rota-card p-5">
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-slate-400 mb-1">Data/Hora</label>
            <input id="datahora" type="datetime-local" class="w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40"/>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Rota</label>
            <input id="rota" placeholder="91136" class="w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40"/>
          </div>
        </div>
      </section>

      <!-- Efetivo -->
      <section class="rota-card p-5">
        <h2 class="text-lg font-semibold mb-4">Efetivo</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-slate-400 mb-1">Motorista(s)</label>
            <div id="list-motorista" class="space-y-2"></div>
            <button type="button" class="btn btn-ghost mt-2" onclick="addTeamItem('motorista')">+ adicionar motorista</button>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Chefe de barca / Encarregado(s)</label>
            <div id="list-encarregado" class="space-y-2"></div>
            <button type="button" class="btn btn-ghost mt-2" onclick="addTeamItem('encarregado')">+ adicionar chefe de barca</button>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Segurança(s)</label>
            <div id="list-seguranca" class="space-y-2"></div>
            <button type="button" class="btn btn-ghost mt-2" onclick="addTeamItem('seguranca')">+ adicionar segurança</button>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Auxiliar(es)</label>
            <div id="list-auxiliares" class="space-y-2"></div>
            <button type="button" class="btn btn-ghost mt-2" onclick="addTeamItem('auxiliares')">+ adicionar auxiliar</button>
          </div>
        </div>
      </section>

      <!-- Blocos (vertical) -->
      <section class="space-y-4">
        <div class="rota-card p-5">
          <label class="block text-lg font-semibold mb-3">Abordados</label>
          <div id="list-abordados" class="space-y-2"></div>
          <button type="button" class="btn btn-ghost w-full justify-center mt-2" onclick="addAbordado()">+ adicionar abordado</button>
        </div>

        <div class="rota-card p-5">
          <label class="block text-lg font-semibold mb-3">Ilícitos</label>
          <div id="list-ilicitos" class="space-y-2"></div>
          <button type="button" class="btn btn-ghost w-full justify-center mt-2" onclick="addIlicito()">+ adicionar ilícito</button>
        </div>

        <div class="rota-card p-5">
          <label class="block text-lg font-semibold mb-3">Veículos</label>
          <div id="list-veiculos" class="space-y-2"></div>
          <button type="button" class="btn btn-ghost w-full justify-center mt-2" onclick="addVeiculo()">+ adicionar veículo</button>
        </div>

        <div class="rota-card p-5">
          <label class="block text-lg font-semibold mb-3">Ocorrências</label>
          <div id="list-ocorrencias" class="space-y-2"></div>
          <button type="button" class="btn btn-ghost w-full justify-center mt-2" onclick="addOcorrencia()">+ adicionar ocorrência</button>
        </div>
      </section>

      <!-- Resultado -->
      <section class="rota-card p-5">
        <h3 class="text-lg font-semibold mb-3">Resultado</h3>
        <div class="grid sm:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm text-slate-400 mb-1">Ocorrências (qtd)</label>
            <input id="res-oc" type="number" min="0" value="0" class="w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40"/>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Apoios (qtd)</label>
            <input id="res-ap" type="number" min="0" value="0" class="w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40"/>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Ações (Blipadas)</label>
            <input id="res-ac" type="number" min="0" value="0" class="w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40"/>
          </div>
        </div>
      </section>

      <!-- Ações (vertical) -->
      <section class="rota-card p-5 flex flex-col gap-3">
        <button class="btn btn-gold w-full" id="saveCloudBtn" type="button">💾 Salvar ilícitos</button>
        <button class="btn btn-red w-full" id="printBtn" type="button">🧾 Imprimir / PDF</button>
        <button class="btn btn-ghost w-full" id="totalsBtn" type="button">📊 Totais 7 dias</button>
      </section>

      <!-- Painel de totais -->
      <section id="totalsPanel" class="rota-card p-5 hidden">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Totais por policial (últimos 7 dias)</h3>
          <div class="flex gap-2">
            <button class="btn btn-ghost" id="exportCsvBtn" type="button">Exportar CSV</button>
            <button class="btn btn-ghost" id="closeTotalsBtn" type="button">Fechar</button>
          </div>
        </div>
        <div id="totalsContent" class="space-y-4"></div>
      </section>
    </div>

    <!-- FOLHA A4 (print bonita) -->
    <div id="sheet" class="hidden">
      <div class="doc-head">
        <div class="logo">R</div>
        <div>
          <h2 class="title">ROTA • Relatório de Serviço Operacional</h2>
          <div class="subtitle">Documento gerado automaticamente</div>
        </div>
      </div>

      <div class="meta">
        <span class="chip" id="meta-data">Data/Hora: —</span>
        <span class="chip" id="meta-rota">Rota: —</span>
      </div>

      <div class="divider"></div>

      <div class="section">
        <h3>Efetivo</h3>
        <div class="kgrid">
          <b>Motorista(s):</b><span id="k-motorista">—</span>
          <b>Encarregado(s):</b><span id="k-encarregado">—</span>
          <b>Segurança(s):</b><span id="k-seguranca">—</span>
          <b>Auxiliar(es):</b><span id="k-auxiliares">—</span>
        </div>
      </div>

      <div class="section">
        <h3>Abordados</h3>
        <ul id="ul-abordados"><li>—</li></ul>
      </div>

      <div class="section">
        <h3>Ilícitos</h3>
        <ul id="ul-ilicitos"><li>—</li></ul>
      </div>

      <div class="section">
        <h3>Veículos</h3>
        <ul id="ul-veiculos"><li>—</li></ul>
      </div>

      <div class="section">
        <h3>Ocorrências</h3>
        <ul id="ul-ocorrencias"><li>—</li></ul>
      </div>

      <div class="section result">
        <h3>Resultado</h3>
        <ul id="ul-resultado">
          <li>0x Ocorrência.</li>
          <li>0x Apoio.</li>
          <li>0x Ação.</li>
        </ul>
      </div>

      <div class="foot">
        <div>RSO • ROTA</div>
        <div id="rodape-data">—</div>
      </div>
    </div>
  </div>

  <!-- Supabase no final (antes do script principal) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /********** Helpers **********/
    const $ = id => document.getElementById(id);
    const pad2 = n => String(n).padStart(2,'0');
    const esc = s => (s||'').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

    const SUPABASE_URL = 'https://ilonwkgtdszmpcjwlezc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsb253a2d0ZHN6bXBjandsZXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzQxMDIsImV4cCI6MjA3NTU1MDEwMn0.Cc-BtnHlXaGVCY6T6iXe0QA1tsfc17aX8lswEICvtw0';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let RANKS = [], OFFICERS = [];
    let lastSavedIllicitHash = '';
    const ROLE_IDS = { motorista:'list-motorista', encarregado:'list-encarregado', seguranca:'list-seguranca', auxiliares:'list-auxiliares' };

    /********** UI builders **********/
    function mkItem(id,v,ph){
      const w=document.createElement('div'); w.className='item';
      w.innerHTML=`<input class="w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40" placeholder="${ph}" value="${v}">
      <button class="btn btn-ghost mt-2" type="button">remover</button>`;
      w.querySelector('button').onclick=()=>w.remove();
      $(id).appendChild(w);
    }
    function addIlicito(v=''){ mkItem('list-ilicitos',v,'ex.: 02x Maconha'); }

    function addOcorrencia(h='',t=''){
      const w=document.createElement('div'); w.className='item rota-card p-3';
      w.innerHTML=`
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <input type="time" value="${h}" class="px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40">
          <input placeholder="Descreva a ocorrência" value="${t}" class="sm:col-span-2 px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40">
        </div>
        <div class="mt-2 text-right"><button class="btn btn-ghost" type="button">remover</button></div>`;
      w.querySelector('button').onclick=()=>w.remove();
      $('list-ocorrencias').appendChild(w);
    }

    function addAbordado(nome='',doc='',sit=''){
      const w=document.createElement('div'); w.className='item rota-card p-3';
      w.innerHTML=`
        <div class="grid md:grid-cols-3 gap-2 w-full">
          <input placeholder="Nome do abordado" value="${esc(nome)}" class="px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40">
          <input placeholder="CPF/ID do abordado" value="${esc(doc)}" class="px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40">
          <input placeholder="Situação (ex.: BOPM — Cb Ducati 20:40)" value="${esc(sit)}" class="px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40">
        </div>
        <div class="mt-2 text-right"><button class="btn btn-ghost" type="button">remover</button></div>`;
      w.querySelector('button').onclick=()=>w.remove();
      $('list-abordados').appendChild(w);
    }

    function addVeiculo(modelo='',cor='',placa='',sit=''){
      const w=document.createElement('div'); w.className='item rota-card p-3';
      w.innerHTML=`
        <div class="grid md:grid-cols-4 gap-2 w-full">
          <input placeholder="Modelo do veículo" value="${esc(modelo)}" class="px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40">
          <input placeholder="Cor" value="${esc(cor)}" class="px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40">
          <input placeholder="Emplacamento" value="${esc(placa)}" class="px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40">
          <input placeholder="Situação (ex.: Apreendido)" value="${esc(sit)}" class="px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40">
        </div>
        <div class="mt-2 text-right"><button class="btn btn-ghost" type="button">remover</button></div>`;
      w.querySelector('button').onclick=()=>w.remove();
      $('list-veiculos').appendChild(w);
    }

    // Efetivo: select nome -> select patente
    function addTeamItem(role){
      const containerId = ROLE_IDS[role];
      const wrap = document.createElement('div'); wrap.className='item rota-card p-3';
      const inner=document.createElement('div'); inner.className='grid grid-cols-1 gap-2';

      const nameSel=document.createElement('select');
      const rankSel=document.createElement('select');
      nameSel.className='w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40';
      rankSel.className='w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40';
      nameSel.innerHTML = `<option value="">Selecione o policial…</option>` + OFFICERS.map(o=>`<option value="${o.id}">${esc(o.name)}</option>`).join('');
      rankSel.innerHTML = `<option value="">Selecione a patente…</option>` + RANKS.map(r=>`<option value="${r.id}">${esc(r.name)}</option>`).join('');
      nameSel.addEventListener('change', e=>{
        const off = OFFICERS.find(o=>o.id===e.target.value);
        if(off) rankSel.value = off.current_rank_id ?? '';
      });

      inner.appendChild(nameSel); inner.appendChild(rankSel);
      const actions=document.createElement('div'); actions.className='mt-2 text-right';
      const del=document.createElement('button'); del.type='button'; del.className='btn btn-ghost'; del.textContent='remover';
      del.onclick=()=>wrap.remove(); actions.appendChild(del);

      wrap.appendChild(inner); wrap.appendChild(actions);
      $(containerId).appendChild(wrap);
    }

    /********** Coleta/Impressão **********/
    function collectRole(role){
      const items=[...($(ROLE_IDS[role])?.querySelectorAll('.item')||[])], out=[];
      items.forEach(it=>{
        const [nameSel, rankSel] = it.querySelectorAll('select');
        const officerId = nameSel?.value || ''; const rankId = rankSel?.value || '';
        if(!officerId) return;
        const off = OFFICERS.find(o=>o.id===officerId);
        const rk  = RANKS.find(r=>String(r.id)===String(rankId));
        out.push({name: off?.name || '', rank_name: rk?.name || '', label:`${rk?.name?rk.name+' ':''}${off?.name||''}`.trim()});
      });
      return out;
    }
    function collect(){
      const L=id=>[...$(id).querySelectorAll('input')].map(i=>i.value).filter(Boolean);
      const O=[...$('list-ocorrencias').children].map(d=>{const ins=d.querySelectorAll('input');return{h:ins[0]?.value,t:ins[1]?.value}}).filter(o=>o.t);

      const motoristaArr=collectRole('motorista'), encarregadoArr=collectRole('encarregado'),
            segurancaArr=collectRole('seguranca'), auxiliaresArr=collectRole('auxiliares');

      const AB=[...$('list-abordados').children].map(w=>{
        const [n,d,s]=w.querySelectorAll('input'); return {nome:n?.value.trim(),doc:d?.value.trim(),sit:s?.value.trim()};
      }).filter(x=>x && (x.nome||x.doc||x.sit));
      const abordadosFmt = AB.map(x=>`${x.nome} — ${x.doc} — ${x.sit}`);

      const VV=[...$('list-veiculos').children].map(w=>{
        const [m,c,p,s]=w.querySelectorAll('input'); return {modelo:m?.value.trim(),cor:c?.value.trim(),placa:p?.value.trim(),sit:s?.value.trim()};
      }).filter(x=>x && (x.modelo||x.cor||x.placa||x.sit));
      const veiculosFmt = VV.map(x=>`${x.modelo} — ${x.cor} — ${x.placa} — ${x.sit}`);

      return {
        datahora:$('datahora').value, rota:$('rota').value,
        motorista:motoristaArr.map(x=>x.label),
        encarregado:encarregadoArr.map(x=>x.label),
        seguranca:segurancaArr.map(x=>x.label),
        auxiliares:auxiliaresArr.map(x=>x.label),
        _pairs:[...motoristaArr,...encarregadoArr,...segurancaArr,...auxiliaresArr],
        ilicitos:L('list-ilicitos'), veiculos:veiculosFmt, ocorrencias:O, abordados:abordadosFmt,
        resOc:+($('res-oc').value||0), resAp:+($('res-ap').value||0), resAc:+($('res-ac').value||0)
      };
    }
    function fillSheet(d){
      const dt=d.datahora?new Date(d.datahora):new Date();
      const dd=`${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
      // meta chips
      const metaData = document.getElementById('meta-data');
      const metaRota = document.getElementById('meta-rota');
      if(metaData) metaData.textContent = `Data/Hora: ${dd}`;
      if(metaRota) metaRota.textContent = `Rota: ${d.rota || '—'}`;

      const joinOrDash = a => (a&&a.length)?esc(a.join(' | ')):'—';
      $('k-motorista').innerHTML=joinOrDash(d.motorista);
      $('k-encarregado').innerHTML=joinOrDash(d.encarregado);
      $('k-seguranca').innerHTML=joinOrDash(d.seguranca);
      $('k-auxiliares').innerHTML=joinOrDash(d.auxiliares);

      const setList=(id,a)=>{const u=$(id); u.innerHTML=''; if(!a||!a.length){u.innerHTML='<li>—</li>';return} a.forEach(v=>{const li=document.createElement('li'); li.innerHTML=esc(v); u.appendChild(li);});};
      setList('ul-abordados',d.abordados); setList('ul-ilicitos',d.ilicitos); setList('ul-veiculos',d.veiculos);

      const ulO=$('ul-ocorrencias'); ulO.innerHTML='';
      if(!d.ocorrencias.length) ulO.innerHTML='<li>—</li>';
      else { d.ocorrencias.sort((a,b)=>(a.h||'').localeCompare(b.h||'')); d.ocorrencias.forEach(o=>{const li=document.createElement('li'); li.innerHTML=esc(o.h?`ÀS ${o.h}: ${o.t}`:o.t); ulO.appendChild(li);}); }

      $('ul-resultado').innerHTML=`<li>${d.resOc}x Ocorrência.</li><li>${d.resAp}x Apoio.</li><li>${d.resAc}x Ação.</li>`;
      const now=new Date(); $('rodape-data').textContent=`Emitido em ${pad2(now.getDate())}/${pad2(now.getMonth()+1)}/${now.getFullYear()} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
    }

    /********** Supabase I/O **********/
    async function loadRanks(){ const {data,error}=await supa.from('ranks').select('id,name,sort_order').order('sort_order'); if(!error) RANKS=data||[]; }
    async function loadOfficers(){ const {data,error}=await supa.from('officers').select('id,name,current_rank_id').eq('active',true).order('name'); if(!error) OFFICERS=data||[]; }

    function parseIlicitosText(multiline){
      const parts=(multiline||'').split(/\n|,|;/).map(s=>s.trim()).filter(Boolean), out=[];
      for(const p of parts){
        let m=p.match(/^(\d+)\s*[x×]?\s*(.+)$/i)||p.match(/^(\d+)\s+(.+)$/i);
        if(m){ out.push({item:m[2].trim().toLowerCase(), qty:parseInt(m[1],10)}); continue; }
        const m2=p.match(/(\d+)/); if(m2){ out.push({item:p.replace(m2[0],'').trim().toLowerCase()||'desconhecido', qty:parseInt(m2[1],10)}); }
        else out.push({item:p.toLowerCase(), qty:1});
      }
      return out;
    }
    function selectedOfficerAndRankPairs(){ const d=collect(); return (d._pairs||[]).map(p=>({name:p.name, rank_name:p.rank_name})); }

    async function saveIllicitsToSupabase(){
      const rota = ($('rota').value||'').trim()||null;
      const lines = [...document.querySelectorAll('#list-ilicitos input')].map(i=>i.value).filter(Boolean).join('\n');
      const items = parseIlicitosText(lines);
      const pairs = selectedOfficerAndRankPairs();
      if(!items.length){ alert('Preencha ao menos 1 ilícito.'); return; }
      if(!pairs.length){ alert('Selecione pelo menos 1 membro de equipe (nome e patente).'); return; }

      const rows = pairs.flatMap(({name,rank_name})=> items.map(({item,qty})=>({
        officer:name, rank_at_time:rank_name, rota, item_type:item, quantity:Number(qty)
      })));

      const btn=$('saveCloudBtn'); const old=btn.textContent; btn.textContent='Salvando…'; btn.disabled=true;
      try{
        const { error } = await supa.from('rso_items').insert(rows);
        if(error) throw error;
        btn.textContent='Salvo!'; lastSavedIllicitHash = String(lines);
      }catch(e){ console.error(e); alert('Falha ao salvar no Supabase.'); }
      finally{ setTimeout(()=>{ btn.textContent=old; btn.disabled=false; }, 1200); }
    }

    async function showTotals7d(){
      const cutoff = new Date(Date.now()-7*24*60*60*1000).toISOString();
      const { data, error } = await supa.from('rso_items')
        .select('officer,item_type,quantity,recorded_at')
        .gte('recorded_at', cutoff);

      if(error){ alert('Erro ao buscar totais.'); return; }

      const agg = {};
      (data||[]).forEach(r=>{
        const off = r.officer || '—';
        if(!agg[off]) agg[off] = {};
        agg[off][r.item_type] = (agg[off][r.item_type] || 0) + Number(r.quantity || 0);
      });
      renderTotals(agg);
    }

    function renderTotals(agg){
      const panel = $('totalsPanel');
      const content = $('totalsContent');
      if(!agg || !Object.keys(agg).length){
        content.innerHTML = '<div class="text-slate-400 text-sm">Sem dados nos últimos 7 dias.</div>';
        panel.classList.remove('hidden');
        return;
      }
      let html = '';
      Object.keys(agg).sort().forEach(off=>{
        html += `<div><h4 class="font-semibold mb-2">${esc(off)}</h4>`;
        html += `<table class="w-full text-sm border border-slate-300/40 rounded-lg overflow-hidden"><thead><tr class="bg-slate-100/80 text-slate-900"><th class="text-left p-2">Item</th><th class="text-right p-2">Quantidade</th></tr></thead><tbody>`;
        const items = agg[off];
        Object.keys(items).sort().forEach(it=>{
          html += `<tr class="odd:bg-slate-800/10"><td class="p-2">${esc(it)}</td><td class="p-2 text-right">${items[it]}</td></tr>`;
        });
        html += `</tbody></table></div>`;
      });
      content.innerHTML = html;
      panel.classList.remove('hidden');
    }

    function exportTotalsCSVFromAgg(agg){
      const rows = [['policial','item','total']];
      Object.entries(agg).forEach(([off, items])=>{
        Object.entries(items).forEach(([item, total])=> rows.push([off,item,total]));
      });
      const escCSV = s => /[\"",;\n]/.test(String(s)) ? `"${String(s).replace(/"/g,'""')}"` : s;
      const csv = rows.map(r=>r.map(escCSV).join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='RSO-totais-7dias.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function validateStructured(){
      const abordados=[...$('list-abordados').children], veiculos=[...$('list-veiculos').children];
      if(!abordados.length){ alert('Adicione pelo menos 1 Abordado.'); return false; }
      if(!veiculos.length){ alert('Adicione pelo menos 1 Veículo.'); return false; }
      for(const w of abordados){ const ins=[...w.querySelectorAll('input')]; if(ins.some(i=>!i.value.trim())){ alert('Preencha todos os campos de Abordados.'); return false; } }
      for(const w of veiculos){ const ins=[...w.querySelectorAll('input')]; if(ins.some(i=>!i.value.trim())){ alert('Preencha todos os campos de Veículos.'); return false; } }
      return true;
    }

    /********** Init **********/
    document.addEventListener('DOMContentLoaded', async ()=>{
      // Data default
      const d=new Date(), z=n=>String(n).padStart(2,'0');
      $('datahora').value=`${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`;

      // Carregar selects
      await Promise.all([loadRanks(), loadOfficers()]);

      // Itens iniciais
      addTeamItem('motorista'); addTeamItem('encarregado'); addTeamItem('seguranca'); addTeamItem('auxiliares');
      addAbordado(); addVeiculo(); addIlicito(); addOcorrencia();

      // Botões de ação
      $('saveCloudBtn').addEventListener('click', saveIllicitsToSupabase);
      $('totalsBtn').addEventListener('click', showTotals7d);
      $('closeTotalsBtn').addEventListener('click', ()=> $('totalsPanel').classList.add('hidden'));
      $('exportCsvBtn').addEventListener('click', ()=>{
        const agg = {};
        [...$('totalsContent').children].forEach(group=>{
          const officer = group.querySelector('h4')?.textContent?.trim() || '—';
          agg[officer] = {};
          group.querySelectorAll('tbody tr').forEach(tr=>{
            const [tdItem, tdQty] = tr.querySelectorAll('td');
            if(tdItem && tdQty) agg[officer][tdItem.textContent.trim()] = Number(tdQty.textContent.trim())||0;
          });
        });
        exportTotalsCSVFromAgg(agg);
      });

      $('printBtn').addEventListener('click', ()=>{
        if(!validateStructured()) return;
        const d=collect(); fillSheet(d); window.print();
      });

      // Expor funções usadas por onclick
      Object.assign(window,{ addTeamItem, addAbordado, addIlicito, addVeiculo, addOcorrencia });
    });
  </script>
</body>
</html>
