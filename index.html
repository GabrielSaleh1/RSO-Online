<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RSO Online</title>
<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb; --line:#2a3647; --brand:#4f9cf9; --btn:#2563eb; --btnH:#1e40af; --field:#0b1220; }
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 16px;text-align:center;color:var(--brand);font-weight:800;letter-spacing:.3px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;margin-bottom:14px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .row>div{flex:1 1 260px;min-width:220px}
  label{display:block;font-weight:700;font-size:.92rem;margin:6px 0}
  input,textarea,select{width:100%;box-sizing:border-box;background:var(--field);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;display:block}
  textarea{min-height:72px;resize:vertical}
  .list{display:grid;gap:10px}
  .item,.item-2{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .item-2 input[type="time"]{width:100px}
  .item button,.item-2 button{flex-shrink:0;padding:8px 12px;height:auto;align-self:center}
  .pill{border:1px dashed var(--line);border-radius:10px;padding:8px 12px;text-align:center;cursor:pointer;color:#bcd3ff;background:#0c1422;font-weight:700}
  .pill:hover{background:#0e1829}
  .muted{color:var(--muted);font-size:.85rem}
  .btn{background:var(--btn);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:800;cursor:pointer}
  .btn:hover{background:var(--btnH)}
  .btn-sec{background:#0c1422;border:1px solid var(--line);color:#cfe0ff}
  @media (max-width:720px){ .row>div{flex:1 1 100%;min-width:unset} }

  /* Impressão A4 */
  @page{size:A4;margin:14mm}
  @media print{
    body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}
    #form-area{display:none!important}
    #sheet{display:block!important}
  }
  #sheet{display:none;background:#fff;color:#0b0b0b;border:1px solid #bfc8d6;border-radius:6px;box-sizing:border-box;padding:14mm;width:100%;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .doc-header{text-align:center;margin-bottom:10px}
  .doc-title{font-weight:900;font-size:22px;color:#0d2a5c;margin:0 0 4px}
  .doc-sub{font-size:12px;color:#3b4a63;margin:0}
  .doc-rule{height:1px;background:linear-gradient(90deg,#ccd6e4 0,#8aa7ff 40%,#ccd6e4 100%);margin:10px 0 14px;border:none}
  .meta{display:flex;justify-content:space-between;gap:12px;font-weight:700;margin-bottom:8px}
  .meta span{white-space:nowrap}
  .section{margin:10px 0 12px}
  .section h3{font-size:14px;margin:0 0 8px;color:#0d2a5c;font-weight:900;letter-spacing:.3px}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:4px 12px;font-size:13px}
  .kv b{color:#22324d}
  ul.clean{margin:0;padding-left:16px;font-size:13px}
  .footer-rule{height:1px;background:#ccd6e4;margin:12px 0 8px}
  .doc-footer{display:flex;justify-content:space-between;font-size:11px;color:#506079}
  table.tot{width:100%;border-collapse:separate;border-spacing:0 6px}
  table.tot th,table.tot td{padding:10px 12px;border:1px solid var(--line)}
  table.tot th{background:#0c1422;text-align:left}
  /* área de gráficos */
  .charts{display:grid;gap:14px;margin-top:12px}
  .charts canvas{background:#0c1422;border:1px solid var(--line);border-radius:12px;padding:10px}
</style>

<!-- Supabase JS v2 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Relatório de Serviço Operacional</h1>

    <!-- FORM -->
    <div id="form-area">
      <div class="panel">
        <div class="row">
          <div><label>Nº do RSO</label><input id="numero" placeholder="0169"></div>
          <div><label>Data/Hora</label><input id="datahora" type="datetime-local"></div>
        </div>
        <div class="row"><div><label>Rota</label><input id="rota" placeholder="91136"></div></div>
      </div>

      <div class="panel">
        <div class="row">
          <div>
            <label>Motorista (Nome)</label>
            <select id="motorista_sel"></select>
          </div>
          <div>
            <label>Motorista (Patente)</label>
            <select id="motorista_rank"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Encarregado (Nome)</label>
            <select id="encarregado_sel"></select>
          </div>
          <div>
            <label>Encarregado (Patente)</label>
            <select id="encarregado_rank"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Segurança (Nome)</label>
            <select id="seguranca_sel"></select>
          </div>
          <div>
            <label>Segurança (Patente)</label>
            <select id="seguranca_rank"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Auxiliar (Nome)</label>
            <select id="auxiliares_sel"></select>
          </div>
          <div>
            <label>Auxiliar (Patente)</label>
            <select id="auxiliares_rank"></select>
          </div>
        </div>
        <div class="muted">Lista de nomes fixa (cadastre/edite pelo painel do Supabase).</div>
      </div>

      <div class="panel">
        <label>Ilícitos</label>
        <div id="list-ilicitos" class="list"></div>
        <div class="pill" onclick="addIlicito()">+ adicionar ilícito</div>
      </div>

      <div class="panel">
        <label>Veículos</label>
        <div id="list-veiculos" class="list"></div>
        <div class="pill" onclick="addVeiculo()">+ adicionar veículo</div>
      </div>

      <div class="panel">
        <label>Ocorrências</label>
        <div id="list-ocorrencias" class="list"></div>
        <div class="pill" onclick="addOcorrencia()">+ adicionar ocorrência</div>
        <div class="muted">Dica: use “ÀS hh:mm: descrição…”.</div>
      </div>

      <div class="panel">
        <label>Abordados</label>
        <div id="list-abordados" class="list"></div>
        <div class="pill" onclick="addAbordado()">+ adicionar abordado</div>
      </div>

      <div class="panel">
        <div class="row">
          <div><label>Ocorrências (qtd)</label><input id="res-oc" type="number" min="0" value="0"></div>
          <div><label>Apoios (qtd)</label><input id="res-ap" type="number" min="0" value="0"></div>
        </div>
        <div class="row">
          <div><label>Ações (qtd)</label><input id="res-ac" type="number" min="0" value="0"></div>
        </div>
      </div>

      <div class="panel" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn" id="saveCloudBtn" type="button">Salvar ilícitos</button>
        <button class="btn btn-sec" id="totalsBtn" type="button">Totais 7 dias</button>
        <button class="btn" id="printBtn" type="button">Imprimir / PDF</button>
      </div>

      <div id="totalsPanel" class="panel" style="display:none">
        <h3 style="margin:0 0 10px">Totais por policial (últimos 7 dias)</h3>

        <!-- gráficos -->
        <div class="charts">
          <canvas id="chartByOfficer" height="220"></canvas>
          <canvas id="chartByItem" height="220"></canvas>
          <canvas id="chartByDay" height="220"></canvas>
        </div>

        <!-- tabela -->
        <div id="totalsContent" style="margin-top:10px"></div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn btn-sec" id="exportCsvBtn" type="button">Exportar CSV</button>
          <button class="btn btn-sec" type="button" onclick="document.getElementById('totalsPanel').style.display='none'">Fechar</button>
        </div>
      </div>
    </div>

    <!-- FOLHA A4 PARA IMPRESSÃO -->
    <div id="sheet">
      <div class="doc-header">
        <h2 class="doc-title">Relatório de Serviço Operacional</h2>
        <p class="doc-sub">Documento gerado automaticamente</p>
      </div>
      <hr class="doc-rule">
      <div class="meta"><span id="meta-numero">Nº: —</span><span id="meta-data">Data/Hora: —</span></div>
      <div class="section"><h3>ROTA</h3><div id="rota-out" style="font-size:13px">—</div></div>
      <div class="section"><h3>EFETIVO</h3>
        <div class="kv">
          <b>Motorista:</b><span id="k-motorista">—</span>
          <b>Encarregado:</b><span id="k-encarregado">—</span>
          <b>Segurança:</b><span id="k-seguranca">—</span>
          <b>Auxiliar:</b><span id="k-auxiliares">—</span>
        </div>
      </div>
      <div class="section"><h3>ILÍCITOS</h3><ul class="clean" id="ul-ilicitos"><li>—</li></ul></div>
      <div class="section"><h3>VEÍCULOS</h3><ul class="clean" id="ul-veiculos"><li>—</li></ul></div>
      <div class="section"><h3>OCORRÊNCIAS</h3><ul class="clean" id="ul-ocorrencias"><li>—</li></ul></div>
      <div class="section"><h3>ABORDADOS</h3><ul class="clean" id="ul-abordados"><li>—</li></ul></div>
      <div class="section"><h3>RESULTADO</h3><ul class="clean" id="ul-resultado"><li>0x Ocorrência.</li><li>0x Apoio.</li><li>0x Ação.</li></ul></div>
      <hr class="footer-rule"><div class="doc-footer"><div>RSO Online</div><div id="rodape-data">—</div></div>
    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);
  const pad2 = n => String(n).padStart(2,'0');
  const esc = s => (s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

  /* ===== Supabase ===== */
  const SUPABASE_URL = 'https://ilonwkgtdszmpcjwlezc.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsb253a2d0ZHN6bXBjandsZXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzQxMDIsImV4cCI6MjA3NTU1MDEwMn0.Cc-BtnHlXaGVCY6T6iXe0QA1tsfc17aX8lswEICvtw0';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===== Roster & Ranks ===== */
  let RANKS = []; let OFFICERS = [];
  const NAME_SELECTS = ['motorista_sel','encarregado_sel','seguranca_sel','auxiliares_sel'];
  const RANK_SELECTS = ['motorista_rank','encarregado_rank','seguranca_rank','auxiliares_rank'];

  async function loadRanks(){
    const { data, error } = await supa.from('ranks').select('id,name,sort_order').order('sort_order', { ascending: true });
    if(error){ console.error(error); alert('Erro ao carregar patentes.'); return; }
    RANKS = data || [];
    RANK_SELECTS.forEach(id => {
      const sel = $(id);
      sel.innerHTML = `<option value="">Selecione a patente…</option>` + RANKS.map(r => `<option value="${r.id}">${esc(r.name)}</option>`).join('');
    });
  }

  async function loadOfficers(){
    const { data, error } = await supa.from('officers').select('id,name,current_rank_id').eq('active', true).order('name');
    if(error){ console.error(error); alert('Erro ao carregar policiais.'); return; }
    OFFICERS = data || [];
    NAME_SELECTS.forEach(id => {
      const sel = $(id);
      sel.innerHTML = `<option value="">Selecione…</option>` + OFFICERS.map(o => `<option value="${esc(o.id)}">${esc(o.name)}</option>`).join('');
    });
  }

  function linkNameToRank(){
    NAME_SELECTS.forEach((nameId, idx) => {
      const rankId = RANK_SELECTS[idx];
      $(nameId).addEventListener('change', (e) => {
        const off = OFFICERS.find(o => o.id === e.target.value);
        $(rankId).value = off?.current_rank_id || '';
      });
    });
  }

  (async function initRoster(){
    // data/hora default
    const d=new Date(), z=n=>String(n).padStart(2,'0');
    $('datahora').value = `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`;
    await loadRanks(); await loadOfficers(); linkNameToRank();
  })();

  /* ===== Campos dinâmicos ===== */
  function addIlicito(v=''){mkItem('list-ilicitos',v,'ex.: 02x Maconha');}
  function addVeiculo(v=''){mkItem('list-veiculos',v,'ex.: BMW R1250 HP - Branca - 57URU265 - Apreendida');}
  function addAbordado(v=''){mkItem('list-abordados',v,'ex.: Renato Cruz – 4910 – BOPM – Cb Ducati 20:14');}
  function addOcorrencia(h='',t=''){const w=document.createElement('div');w.className='item-2';
    w.innerHTML=`<input type="time" value="${h}"><input placeholder="Descreva a ocorrência" value="${t}"><button class="btn btn-sec" type="button">remover</button>`;
    w.querySelector('button').onclick=()=>w.remove();$('list-ocorrencias').appendChild(w);}
  function mkItem(id,v,ph){const w=document.createElement('div');w.className='item';
    w.innerHTML=`<input placeholder="${ph}" value="${v}"><button class="btn btn-sec" type="button">remover</button>`;
    w.querySelector('button').onclick=()=>w.remove();$(id).appendChild(w);}
  if(!$('list-ilicitos').children.length) addIlicito();
  if(!$('list-veiculos').children.length) addVeiculo();
  if(!$('list-ocorrencias').children.length) addOcorrencia();
  if(!$('list-abordados').children.length) addAbordado();

  /* ===== Impressão ===== */
  function collect(){
    const L=id=>[...$(id).querySelectorAll('input')].map(i=>i.value).filter(Boolean);
    const O=[...$('list-ocorrencias').children].map(d=>{const [h,t]=d.querySelectorAll('input');return{h:h.value,t:t.value}}).filter(o=>o.t);

    const officerById = id => OFFICERS.find(o => o.id === id)?.name || '';
    const rankById = id => RANKS.find(r => String(r.id) === String(id))?.name || '';
    const mName = officerById($('motorista_sel').value);
    const eName = officerById($('encarregado_sel').value);
    const sName = officerById($('seguranca_sel').value);
    const aName = officerById($('auxiliares_sel').value);
    const mRank = rankById($('motorista_rank').value);
    const eRank = rankById($('encarregado_rank').value);
    const sRank = rankById($('seguranca_rank').value);
    const aRank = rankById($('auxiliares_rank').value);

    return{
      numero:$('numero').value,datahora:$('datahora').value,rota:$('rota').value,
      motorista: mRank && mName ? `${mRank} ${mName}` : (mName || ''),
      encarregado: eRank && eName ? `${eRank} ${eName}` : (eName || ''),
      seguranca: sRank && sName ? `${sRank} ${sName}` : (sName || ''),
      auxiliares: aRank && aName ? `${aRank} ${aName}` : (aName || ''),
      ilicitos:L('list-ilicitos'),veiculos:L('list-veiculos'),
      ocorrencias:O,abordados:L('list-abordados'),
      resOc:+($('res-oc').value||0),resAp:+($('res-ap').value||0),resAc:+($('res-ac').value||0),
    };
  }
  function fillSheet(d){
    const dt=d.datahora?new Date(d.datahora):new Date();
    const dd=`${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
    $('meta-numero').textContent=`Nº: ${d.numero||'—'}`; $('meta-data').textContent=`Data/Hora: ${dd}`;
    $('rota-out').textContent=d.rota||'—';
    $('k-motorista').textContent=d.motorista||'—';
    $('k-encarregado').textContent=d.encarregado||'—';
    $('k-seguranca').textContent=d.seguranca||'—';
    $('k-auxiliares').textContent=d.auxiliares||'—';
    const setList=(id,a)=>{const u=$(id);u.innerHTML=''; if(!a||!a.length){u.innerHTML='<li>—</li>';return} a.forEach(v=>{const li=document.createElement('li'); li.innerHTML=esc(v); u.appendChild(li);});};
    setList('ul-ilicitos',d.ilicitos); setList('ul-veiculos',d.veiculos); setList('ul-abordados',d.abordados);
    const ulO=$('ul-ocorrencias'); ulO.innerHTML=''; if(!d.ocorrencias.length){ulO.innerHTML='<li>—</li>';} else { d.ocorrencias.sort((a,b)=>(a.h||'').localeCompare(b.h||'')).forEach(o=>{ const li=document.createElement('li'); li.innerHTML=esc(o.h?`ÀS ${o.h}: ${o.t}`:o.t); ulO.appendChild(li); }); }
    $('ul-resultado').innerHTML=`<li>${d.resOc}x Ocorrência.</li><li>${d.resAp}x Apoio.</li><li>${d.resAc}x Ação.</li>`;
    const now=new Date(); $('rodape-data').textContent=`Emitido em ${pad2(now.getDate())}/${pad2(now.getMonth()+1)}/${now.getFullYear()} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  }
  $('printBtn').addEventListener('click',()=>{fillSheet(collect());window.print();});
  window.onbeforeprint=()=>fillSheet(collect());

  /* ===== Parser de ilícitos ===== */
  function parseIlicitosText(multiline){
    const parts = (multiline||'').split(/\n|,|;/).map(s=>s.trim()).filter(Boolean);
    const out=[];
    for(const p of parts){
      let m = p.match(/^(\d+)\s*[x×]?\s*(.+)$/i) || p.match(/^(\d+)\s+(.+)$/i);
      if(m){ out.push({item:m[2].trim().toLowerCase(), qty:parseInt(m[1],10)}); continue; }
      const m2 = p.match(/(\d+)/);
      if(m2){ out.push({item:p.replace(m2[0],'').trim().toLowerCase()||'desconhecido', qty:parseInt(m2[1],10)}); }
      else{ out.push({item:p.toLowerCase(), qty:1}); }
    }
    return out;
  }

  /* ===== Salvar ilícitos ===== */
  function selectedOfficerAndRankPairs(){
    const pairs = [];
    const pick = (selId, rankId) => {
      const oid = $(selId).value || '';
      const rid = $(rankId).value || '';
      if(!oid || !rid) return;
      const o = OFFICERS.find(x=>x.id===oid);
      const r = RANKS.find(x=>String(x.id)===String(rid));
      if(o && r) pairs.push({ name:o.name, rank_name:r.name });
    };
    pick('motorista_sel','motorista_rank');
    pick('encarregado_sel','encarregado_rank');
    pick('seguranca_sel','seguranca_rank');
    pick('auxiliares_sel','auxiliares_rank');
    return pairs;
  }

  async function saveIllicitsToSupabase(){
    const rota = ($('rota').value || '').trim() || null;
    const lines = [...document.querySelectorAll('#list-ilicitos input')].map(i=>i.value).filter(Boolean).join('\n');
    const items = parseIlicitosText(lines);
    const pairs = selectedOfficerAndRankPairs();

    if(!items.length){ alert('Preencha ao menos 1 ilícito.'); return; }
    if(!pairs.length){ alert('Selecione Nome e Patente para a equipe.'); return; }

    const rows = pairs.flatMap(({name, rank_name}) =>
      items.map(({item, qty}) => ({
        officer: name,
        rank_at_time: rank_name,
        rota,
        item_type: item,
        quantity: Number(qty)
      }))
    );

    const btn = $('saveCloudBtn'); const old = btn.textContent;
    btn.textContent = 'Salvando…'; btn.disabled = true;
    try{
      const { error } = await supa.from('rso_items').insert(rows);
      if(error){ console.error(error); alert('Falha ao salvar no Supabase. Veja o console.'); return; }
      btn.textContent = 'Salvo!';
    }catch(e){
      console.error(e); alert('Falha de rede/JS. Veja o console.');
    }finally{
      setTimeout(()=>{ btn.textContent = old; btn.disabled=false; }, 1200);
    }
  }
  $('saveCloudBtn').addEventListener('click', saveIllicitsToSupabase);

  /* ====== Gráficos (Chart.js) + Totais 7 dias ====== */
  let chartByOfficer, chartByItem, chartByDay;

  function destroyCharts(){
    [chartByOfficer, chartByItem, chartByDay].forEach(ch=>{
      if(ch){ ch.destroy(); }
    });
    chartByOfficer = chartByItem = chartByDay = null;
  }

  function niceColors(n){
    const base = [
      '#60a5fa','#f472b6','#34d399','#f59e0b','#a78bfa',
      '#22d3ee','#fb7185','#4ade80','#eab308','#c084fc'
    ];
    const out=[]; for(let i=0;i<n;i++) out.push(base[i%base.length]);
    return out;
  }

  function renderCharts(aggByOfficer, aggByItem, seriesByDay){
    destroyCharts();

    // 1) Barras por policial
    const offNames = Object.keys(aggByOfficer);
    const offTotals = offNames.map(n=>{
      const obj = aggByOfficer[n]; return Object.values(obj).reduce((a,b)=>a+b,0);
    });
    chartByOfficer = new Chart($('#chartByOfficer'), {
      type:'bar',
      data:{ labels: offNames, datasets:[{ label:'Total por policial (7 dias)', data: offTotals, backgroundColor:niceColors(offTotals.length) }]},
      options:{ responsive:true, plugins:{legend:{labels:{color:'#e5e7eb'}}}, scales:{x:{ticks:{color:'#e5e7eb'}}, y:{beginAtZero:true,ticks:{color:'#e5e7eb'}}}}
    });

    // 2) Rosca por tipo
    const itemNames = Object.keys(aggByItem);
    const itemTotals = itemNames.map(k=>aggByItem[k]);
    chartByItem = new Chart($('#chartByItem'), {
      type:'doughnut',
      data:{ labels:itemNames, datasets:[{ label:'Por tipo de ilícito', data:itemTotals, backgroundColor:niceColors(itemTotals.length)}]},
      options:{ plugins:{legend:{labels:{color:'#e5e7eb'}}}}
    });

    // 3) Linha por dia
    const dayLabels = Object.keys(seriesByDay).sort();
    const dayTotals = dayLabels.map(k=>seriesByDay[k]);
    chartByDay = new Chart($('#chartByDay'), {
      type:'line',
      data:{ labels:dayLabels, datasets:[{ label:'Total por dia', data:dayTotals, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,.25)', tension:.2, fill:true }]},
      options:{ plugins:{legend:{labels:{color:'#e5e7eb'}}}, scales:{x:{ticks:{color:'#e5e7eb'}}, y:{beginAtZero:true,ticks:{color:'#e5e7eb'}}}}
    });
  }

  function renderTotals(agg){
    const c = $('totalsContent');
    if(!agg || !Object.keys(agg).length){ c.innerHTML='<div class="muted">Sem dados nos últimos 7 dias.</div>'; return; }
    let html = '';
    Object.keys(agg).sort().forEach(off=>{
      html += `<h4 style="margin:10px 0 6px">${esc(off)}</h4>`;
      html += `<table class="tot"><thead><tr><th>Item</th><th>Quantidade</th></tr></thead><tbody>`;
      const items = agg[off];
      Object.keys(items).sort().forEach(it=>{
        html += `<tr><td>${esc(it)}</td><td>${items[it]}</td></tr>`;
      });
      html += `</tbody></table>`;
    });
    c.innerHTML = html;
  }

  function exportTotalsCSV(agg){
    const rows = [['policial','item','total']];
    Object.entries(agg).forEach(([off, items])=>{
      Object.entries(items).forEach(([item, total])=>{
        rows.push([off, item, total]);
      });
    });
    const escape = s => /[",;\n]/.test(String(s)) ? `"${String(s).replace(/"/g,'""')}"` : s;
    const csv = rows.map(r=>r.map(escape).join(';')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='RSO-totais-7dias.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // ======= FUNÇÃO CORRIGIDA: Totais 7 dias (detecta coluna de data) =======
  async function showTotals7d(){
    const cutoff = Date.now() - 7*24*60*60*1000;

    // 1) Busca tudo e deixa o JS decidir qual coluna de data usar
    const { data, error } = await supa.from('rso_items').select('*');

    if (error) {
      console.error('Erro Supabase:', error);
      alert('Erro ao buscar totais. Veja o console.');
      return;
    }

    // 2) Decide qual coluna de data usar
    const pickTime = (row) => row.recorded_at ?? row.created_at ?? row.inserted_at ?? null;

    // 3) Filtra últimos 7 dias (se houver coluna temporal; senão, mostra tudo)
    const last7d = (data || []).filter(r => {
      const t = pickTime(r);
      if (!t) return true;
      const ms = new Date(t).getTime();
      return !isNaN(ms) && ms >= cutoff;
    });

    // 4) Agregações
    const aggByOfficer = {}; // { officer: {item: total} }
    const aggByItem    = {}; // { item: total }
    const seriesByDay  = {}; // { 'dd/mm': total }

    last7d.forEach(r=>{
      const off = r.officer || '—';
      const it  = (r.item_type || '—').toLowerCase();
      const q   = Number(r.quantity || 0);

      if(!aggByOfficer[off]) aggByOfficer[off] = {};
      aggByOfficer[off][it] = (aggByOfficer[off][it] || 0) + q;

      aggByItem[it] = (aggByItem[it] || 0) + q;

      const when = pickTime(r);
      const d = when ? new Date(when) : new Date();
      const key = `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}`;
      seriesByDay[key] = (seriesByDay[key] || 0) + q;
    });

    // 5) Renderiza tabela e gráficos
    renderTotals(aggByOfficer);
    renderCharts(aggByOfficer, aggByItem, seriesByDay);

    $('totalsPanel').style.display = 'block';
    $('exportCsvBtn').onclick = ()=> exportTotalsCSV(aggByOfficer);
  }

  document.getElementById('totalsBtn').addEventListener('click', showTotals7d);
  document.getElementById('printBtn').addEventListener('click', ()=>{ const d=collect(); fillSheet(d); window.print(); });
  window.onbeforeprint = ()=> fillSheet(collect());
</script>
</body>
</html>
